{% extends "base.html" %}

{% block title %}CallBunker Personal Tutorial{% endblock %}

{% block content %}
<div class="container">
    <!-- Header -->
    <div class="text-center mb-4">
        <h1 class="text-white">
            <i class="fas fa-graduation-cap me-2 text-primary"></i>
            Personal CallBunker Tutorial
        </h1>
        <p class="text-light">Learn how to set up and use your free call screening system</p>
    </div>

    <!-- Progress Bar -->
    <div class="card border-primary mb-4" style="background: rgba(13, 110, 253, 0.1);">
        <div class="card-body">
            <h6 class="text-primary mb-3">
                <i class="fas fa-tasks me-2"></i>Setup Progress
            </h6>
            <div class="progress mb-2" style="height: 20px;">
                <div class="progress-bar bg-primary" role="progressbar" style="width: 0%" id="progress-bar">
                    <span class="fw-bold" id="progress-text">0 of 5 steps completed</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Tutorial Steps -->
    <div class="row">
        <div class="col-lg-8">
            <!-- Step 1: Understanding Your System -->
            <div class="tutorial-step card border-secondary mb-4" data-step="1" style="background: rgba(108, 117, 125, 0.1);">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0 text-light">
                        <span class="step-icon badge bg-secondary me-2">1</span>
                        Understanding Your Personal System
                    </h5>
                    <div class="step-status">
                        <i class="fas fa-circle text-muted"></i>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="text-info">Your Setup:</h6>
                            <ul class="text-light">
                                <li><strong>Your Google Voice:</strong> <code class="text-success">(617) 942-1250</code></li>
                                <li><strong>CallBunker Number:</strong> <code class="text-warning">{{ format_phone(tenant.screening_number) }}</code></li>
                                <li><strong>Your Real Phone:</strong> <code class="text-info">{{ format_phone(tenant.forward_to) }}</code></li>
                            </ul>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-primary">How It Works:</h6>
                            <div class="flow-diagram text-center">
                                <div class="d-flex align-items-center justify-content-center">
                                    <span class="badge bg-success">Caller</span>
                                    <i class="fas fa-arrow-right text-muted mx-2"></i>
                                    <span class="badge bg-warning">Google Voice</span>
                                    <i class="fas fa-arrow-right text-muted mx-2"></i>
                                    <span class="badge bg-danger">CallBunker</span>
                                    <i class="fas fa-arrow-right text-muted mx-2"></i>
                                    <span class="badge bg-info">Your Phone</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <button class="btn btn-success mt-3" onclick="completeStep(1)">
                        <i class="fas fa-check me-2"></i>I Understand My Setup
                    </button>
                </div>
            </div>

            <!-- Step 2: Configure Google Voice -->
            <div class="tutorial-step card border-secondary mb-4" data-step="2" style="background: rgba(108, 117, 125, 0.1);">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0 text-light">
                        <span class="step-icon badge bg-secondary me-2">2</span>
                        Configure Google Voice Forwarding
                    </h5>
                    <div class="step-status">
                        <i class="fas fa-circle text-muted"></i>
                    </div>
                </div>
                <div class="card-body">
                    <div class="alert alert-warning border-warning" style="background: rgba(255, 193, 7, 0.2);">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>Critical:</strong> Caller ID must be set to <strong>OFF</strong> for proper operation
                    </div>
                    
                    <h6 class="text-primary">Step-by-Step Instructions:</h6>
                    <ol class="text-light">
                        <li>Go to <a href="https://voice.google.com" target="_blank" class="text-info">voice.google.com</a></li>
                        <li>Click <span class="badge bg-secondary">Settings</span> â†’ <span class="badge bg-secondary">Calls</span></li>
                        <li>Set <strong>Caller ID</strong> to <span class="text-danger">OFF</span></li>
                        <li>Under "Forwarding", add this number: <code class="text-warning bg-dark px-2 py-1 rounded">{{ format_phone(tenant.screening_number) }}</code></li>
                        <li>Enable forwarding to CallBunker number</li>
                    </ol>
                    
                    <div class="mt-3">
                        <button class="btn btn-primary me-2" onclick="window.open('https://voice.google.com', '_blank')">
                            <i class="fas fa-external-link-alt me-2"></i>Open Google Voice
                        </button>
                        <button class="btn btn-success" onclick="completeStep(2)">
                            <i class="fas fa-check me-2"></i>Forwarding Configured
                        </button>
                    </div>
                </div>
            </div>

            <!-- Step 3: Learn Authentication -->
            <div class="tutorial-step card border-secondary mb-4" data-step="3" style="background: rgba(108, 117, 125, 0.1);">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0 text-light">
                        <span class="step-icon badge bg-secondary me-2">3</span>
                        Learn Your Authentication Methods
                    </h5>
                    <div class="step-status">
                        <i class="fas fa-circle text-muted"></i>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6 class="text-warning">
                                <i class="fas fa-keyboard me-2"></i>PIN Method
                            </h6>
                            <div class="input-group mb-3">
                                <span class="input-group-text bg-warning text-dark">PRESS:</span>
                                <input type="text" class="form-control bg-dark text-warning fw-bold fs-4 text-center" 
                                       value="{{ tenant.current_pin }}" readonly>
                            </div>
                            <small class="text-light">Callers enter this on their keypad</small>
                        </div>
                        <div class="col-md-6">
                            <h6 class="text-success">
                                <i class="fas fa-microphone me-2"></i>Verbal Method
                            </h6>
                            <div class="input-group mb-3">
                                <span class="input-group-text bg-success text-white">SAY:</span>
                                <input type="text" class="form-control bg-dark text-success fw-bold" 
                                       value="{{ tenant.verbal_code }}" readonly>
                            </div>
                            <small class="text-light">Callers can speak this phrase</small>
                        </div>
                    </div>
                    
                    <div class="alert alert-info border-info mt-3" style="background: rgba(13, 202, 240, 0.2);">
                        <i class="fas fa-lightbulb me-2"></i>
                        <strong>Auto-Whitelist:</strong> After successful authentication, callers bypass future screening automatically.
                    </div>
                    
                    <button class="btn btn-success" onclick="completeStep(3)">
                        <i class="fas fa-check me-2"></i>I Know My Authentication
                    </button>
                </div>
            </div>

            <!-- Step 4: Test Call -->
            <div class="tutorial-step card border-secondary mb-4" data-step="4" style="background: rgba(108, 117, 125, 0.1);">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0 text-light">
                        <span class="step-icon badge bg-secondary me-2">4</span>
                        Test Your Setup
                    </h5>
                    <div class="step-status">
                        <i class="fas fa-circle text-muted"></i>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <h6 class="text-primary">Ready to test?</h6>
                            <p class="text-light mb-2">
                                Have someone call your Google Voice number:
                            </p>
                            <div class="d-flex align-items-center gap-3 mb-3">
                                <code class="text-success bg-dark px-3 py-2 rounded fs-5">(617) 942-1250</code>
                                <small class="text-light">
                                    They'll be asked for PIN <code class="text-warning">{{ tenant.current_pin }}</code> 
                                    or to say "<span class="text-success">{{ tenant.verbal_code }}</span>"
                                </small>
                            </div>
                        </div>
                        <div class="col-md-4 text-end">
                            <button class="btn btn-primary mb-2" onclick="initiateTestCall('personal')">
                                <i class="fas fa-phone me-2"></i>Get Test Instructions
                            </button>
                            <br>
                            <button class="btn btn-success" onclick="completeStep(4)">
                                <i class="fas fa-check me-2"></i>Test Successful
                            </button>
                        </div>
                    </div>
                    
                    <div id="test-instructions" class="alert alert-primary border-primary mt-3" style="background: rgba(13, 110, 253, 0.2); display: none;">
                        <h6 class="text-primary">Test Call Instructions:</h6>
                        <div id="test-details"></div>
                    </div>
                </div>
            </div>

            <!-- Step 5: Advanced Features -->
            <div class="tutorial-step card border-secondary mb-4" data-step="5" style="background: rgba(108, 117, 125, 0.1);">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0 text-light">
                        <span class="step-icon badge bg-secondary me-2">5</span>
                        Explore Advanced Features
                    </h5>
                    <div class="step-status">
                        <i class="fas fa-circle text-muted"></i>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="text-center">
                                <i class="fas fa-users fa-2x text-info mb-2"></i>
                                <h6 class="text-info">Whitelist Management</h6>
                                <p class="text-light small">Manually add trusted callers</p>
                                <a href="{{ url_for('admin.admin_home') }}" class="btn btn-outline-info btn-sm">
                                    Manage Whitelist
                                </a>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="text-center">
                                <i class="fas fa-chart-line fa-2x text-warning mb-2"></i>
                                <h6 class="text-warning">Call Statistics</h6>
                                <p class="text-light small">View call logs and blocks</p>
                                <a href="{{ url_for('admin.admin_home') }}" class="btn btn-outline-warning btn-sm">
                                    View Stats
                                </a>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="text-center">
                                <i class="fas fa-cog fa-2x text-success mb-2"></i>
                                <h6 class="text-success">System Settings</h6>
                                <p class="text-light small">Customize authentication</p>
                                <a href="{{ url_for('admin.admin_home') }}" class="btn btn-outline-success btn-sm">
                                    Settings
                                </a>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-4 text-center">
                        <button class="btn btn-success btn-lg" onclick="completeStep(5)">
                            <i class="fas fa-graduation-cap me-2"></i>Tutorial Complete!
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4">
            <div class="card border-info" style="background: rgba(13, 202, 240, 0.1);">
                <div class="card-header">
                    <h6 class="text-info mb-0">
                        <i class="fas fa-question-circle me-2"></i>Quick Help
                    </h6>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <h6 class="text-light">Common Issues:</h6>
                        <ul class="text-light small">
                            <li>Calls go straight to voicemail? Check Google Voice forwarding</li>
                            <li>Caller ID shows your number? Disable Google Voice caller ID</li>
                            <li>Authentication not working? Verify PIN/verbal code</li>
                        </ul>
                    </div>
                    
                    <div class="mb-3">
                        <h6 class="text-light">Your Settings:</h6>
                        <div class="bg-dark p-2 rounded">
                            <small class="text-light d-block">PIN: <code class="text-warning">{{ tenant.current_pin }}</code></small>
                            <small class="text-light d-block">Verbal: <code class="text-success">{{ tenant.verbal_code }}</code></small>
                            <small class="text-light d-block">CallBunker: <code class="text-warning">{{ format_phone(tenant.screening_number) }}</code></small>
                        </div>
                    </div>
                    
                    <div class="d-grid">
                        <a href="/" class="btn btn-outline-info">
                            <i class="fas fa-home me-2"></i>Back to Dashboard
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let completedSteps = new Set();

function completeStep(stepNumber) {
    completedSteps.add(stepNumber);
    
    // Update step visual state
    const stepElement = document.querySelector(`[data-step="${stepNumber}"]`);
    const stepIcon = stepElement.querySelector('.step-icon');
    const stepStatus = stepElement.querySelector('.step-status i');
    
    stepIcon.classList.remove('bg-secondary');
    stepIcon.classList.add('bg-success');
    stepStatus.classList.remove('fa-circle', 'text-muted');
    stepStatus.classList.add('fa-check-circle', 'text-success');
    
    // Update progress bar
    updateProgress();
    
    // Track progress
    fetch('/tutorial/step-progress', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            step_id: `personal_step_${stepNumber}`,
            completed: true
        })
    });
    
    // Auto-scroll to next step
    if (stepNumber < 5) {
        setTimeout(() => {
            document.querySelector(`[data-step="${stepNumber + 1}"]`).scrollIntoView({
                behavior: 'smooth',
                block: 'center'
            });
        }, 500);
    }
}

function updateProgress() {
    const totalSteps = 5;
    const completed = completedSteps.size;
    const percentage = (completed / totalSteps) * 100;
    
    const progressBar = document.getElementById('progress-bar');
    const progressText = document.getElementById('progress-text');
    
    progressBar.style.width = percentage + '%';
    progressText.textContent = `${completed} of ${totalSteps} steps completed`;
    
    if (completed === totalSteps) {
        progressBar.classList.remove('bg-primary');
        progressBar.classList.add('bg-success');
        progressText.textContent = 'ðŸŽ‰ Tutorial Complete!';
    }
}

function initiateTestCall(systemType) {
    fetch('/tutorial/test-call', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            system_type: systemType
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const instructionsDiv = document.getElementById('test-instructions');
            const detailsDiv = document.getElementById('test-details');
            
            detailsDiv.innerHTML = `
                <ol class="text-primary mb-0">
                    <li>Call your Google Voice: <strong>${data.call_number}</strong></li>
                    <li>You'll hear CallBunker's greeting</li>
                    <li>Enter PIN: <code class="bg-dark text-warning px-2 py-1 rounded">${data.pin}</code> OR</li>
                    <li>Say verbal code: "<code class="bg-dark text-success px-2 py-1 rounded">${data.verbal_code}</code>"</li>
                    <li>Call should connect to your real phone</li>
                </ol>
            `;
            
            instructionsDiv.style.display = 'block';
        } else {
            alert('Error getting test instructions: ' + data.error);
        }
    })
    .catch(error => {
        alert('Error: ' + error.message);
    });
}
</script>
{% endblock %}