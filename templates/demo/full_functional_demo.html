<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CallBunker - Full Functional Demo</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            background: #f8f9fa;
            padding: 20px;
            min-height: 100vh;
        }
        
        .demo-container {
            max-width: 400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        
        .demo-banner {
            background: #28a745;
            color: white;
            text-align: center;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            font-weight: bold;
        }
        
        .screen {
            display: none;
        }
        
        .screen.active {
            display: block;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-label {
            display: block;
            font-weight: 600;
            margin-bottom: 5px;
            color: #333;
        }
        
        .form-input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
        }
        
        .btn {
            width: 100%;
            padding: 15px;
            background: #007AFF;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 10px;
        }
        
        .btn:hover {
            background: #0056CC;
        }
        
        .btn-secondary {
            background: #6c757d;
        }
        
        .btn-success {
            background: #28a745;
        }
        
        .btn-danger {
            background: #dc3545;
        }
        
        .success-box {
            background: #d4edda;
            color: #155724;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border: 1px solid #c3e6cb;
        }
        
        .error-box {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border: 1px solid #f5c6cb;
        }
        
        .info-box {
            background: #d1ecf1;
            color: #0c5460;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border: 1px solid #bee5eb;
        }
        
        .defense-number {
            font-size: 18px;
            font-weight: bold;
            color: #28a745;
        }
        
        .call-item {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 8px;
            border-left: 4px solid #007AFF;
        }
        
        .contact-item {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        
        .navigation {
            display: flex;
            justify-content: space-around;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }
        
        .nav-btn {
            background: none;
            border: none;
            padding: 10px;
            cursor: pointer;
            border-radius: 8px;
            color: #666;
            font-size: 12px;
        }
        
        .nav-btn.active {
            color: #007AFF;
            background: #e3f2fd;
        }
        
        .dialer-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin: 20px 0;
        }
        
        .dial-btn {
            aspect-ratio: 1;
            border: none;
            border-radius: 50%;
            background: #f8f9fa;
            font-size: 20px;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .dial-btn:active {
            transform: scale(0.95);
        }
        
        .phone-display {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            margin-bottom: 15px;
            font-size: 18px;
            min-height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
    </style>
</head>
<body>
    <div class="demo-container">
        <div class="demo-banner">
            üöÄ CallBunker Full Functional Demo - Live Backend Integration
        </div>

        <!-- Signup Screen -->
        <div class="screen active" id="signup-screen">
            <h2 style="text-align: center; margin-bottom: 20px;">Create CallBunker Account</h2>
            
            <div id="signup-status"></div>
            
            <form id="signup-form">
                <div class="form-group">
                    <label class="form-label">Name</label>
                    <input type="text" id="name" class="form-input" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Email</label>
                    <input type="email" id="email" class="form-input" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Google Voice Number</label>
                    <input type="tel" id="google_voice" class="form-input" placeholder="(555) 123-4567" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Real Phone Number</label>
                    <input type="tel" id="real_phone" class="form-input" placeholder="(555) 987-6543" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">PIN (4 digits)</label>
                    <input type="text" id="pin" class="form-input" placeholder="1234" maxlength="4" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Verbal Code</label>
                    <input type="text" id="verbal_code" class="form-input" placeholder="Your secret phrase" required>
                </div>
                
                <button type="submit" class="btn">Create Account</button>
            </form>
            
            <div class="info-box">
                <strong>Live Backend Integration:</strong> This will create a real account in the CallBunker database and assign you a Defense Number from the Twilio phone pool.
            </div>
        </div>

        <!-- Dashboard Screen -->
        <div class="screen" id="dashboard-screen">
            <h2 style="text-align: center; margin-bottom: 20px;">CallBunker Dashboard</h2>
            
            <div id="user-info"></div>
            <div id="dashboard-status"></div>
            
            <div class="navigation">
                <button class="nav-btn active" onclick="showDashboard()">üè†<br>Home</button>
                <button class="nav-btn" onclick="showDialer()">üìû<br>Dialer</button>
                <button class="nav-btn" onclick="showHistory()">üìã<br>History</button>
                <button class="nav-btn" onclick="showContacts()">üë•<br>Contacts</button>
            </div>
        </div>

        <!-- Dialer Screen -->
        <div class="screen" id="dialer-screen">
            <h2 style="text-align: center; margin-bottom: 20px;">Protected Dialer</h2>
            
            <div class="phone-display" id="phone-display">Enter number</div>
            
            <div class="dialer-grid">
                <button class="dial-btn" onclick="addDigit('1')">1</button>
                <button class="dial-btn" onclick="addDigit('2')">2</button>
                <button class="dial-btn" onclick="addDigit('3')">3</button>
                <button class="dial-btn" onclick="addDigit('4')">4</button>
                <button class="dial-btn" onclick="addDigit('5')">5</button>
                <button class="dial-btn" onclick="addDigit('6')">6</button>
                <button class="dial-btn" onclick="addDigit('7')">7</button>
                <button class="dial-btn" onclick="addDigit('8')">8</button>
                <button class="dial-btn" onclick="addDigit('9')">9</button>
                <button class="dial-btn" onclick="addDigit('*')">*</button>
                <button class="dial-btn" onclick="addDigit('0')">0</button>
                <button class="dial-btn" onclick="addDigit('#')">#</button>
            </div>
            
            <button class="btn btn-success" onclick="makeCall()">üìû Call with Privacy Protection</button>
            <button class="btn btn-secondary" onclick="clearNumber()">Clear</button>
            
            <div id="call-status"></div>
            
            <div class="navigation">
                <button class="nav-btn" onclick="showDashboard()">üè†<br>Home</button>
                <button class="nav-btn active">üìû<br>Dialer</button>
                <button class="nav-btn" onclick="showHistory()">üìã<br>History</button>
                <button class="nav-btn" onclick="showContacts()">üë•<br>Contacts</button>
            </div>
        </div>

        <!-- Call History Screen -->
        <div class="screen" id="history-screen">
            <h2 style="text-align: center; margin-bottom: 20px;">Call History</h2>
            
            <div id="history-list"></div>
            
            <button class="btn" onclick="loadCallHistory()">üîÑ Refresh from Backend</button>
            
            <div class="navigation">
                <button class="nav-btn" onclick="showDashboard()">üè†<br>Home</button>
                <button class="nav-btn" onclick="showDialer()">üìû<br>Dialer</button>
                <button class="nav-btn active">üìã<br>History</button>
                <button class="nav-btn" onclick="showContacts()">üë•<br>Contacts</button>
            </div>
        </div>

        <!-- Contacts Screen -->
        <div class="screen" id="contacts-screen">
            <h2 style="text-align: center; margin-bottom: 20px;">Trusted Contacts</h2>
            
            <div class="form-group">
                <label class="form-label">Add Contact</label>
                <input type="text" id="contact-name" class="form-input" placeholder="Contact Name">
                <input type="tel" id="contact-phone" class="form-input" placeholder="Phone Number">
                <button class="btn" onclick="addContact()">Add to Trusted List</button>
            </div>
            
            <div id="contacts-list"></div>
            
            <button class="btn" onclick="loadContacts()">üîÑ Refresh from Backend</button>
            
            <div class="navigation">
                <button class="nav-btn" onclick="showDashboard()">üè†<br>Home</button>
                <button class="nav-btn" onclick="showDialer()">üìû<br>Dialer</button>
                <button class="nav-btn" onclick="showHistory()">üìã<br>History</button>
                <button class="nav-btn active">üë•<br>Contacts</button>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let currentUser = null;
        let currentPhone = '';
        const baseURL = window.location.origin;

        // Utility functions
        function formatPhone(phone) {
            const digits = phone.replace(/\D/g, '');
            if (digits.length === 10) {
                return `(${digits.slice(0,3)}) ${digits.slice(3,6)}-${digits.slice(6)}`;
            }
            return phone;
        }

        function showMessage(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            const className = type === 'error' ? 'error-box' : type === 'success' ? 'success-box' : 'info-box';
            element.innerHTML = `<div class="${className}">${message}</div>`;
        }

        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
        }

        // Signup functionality
        document.getElementById('signup-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = new FormData();
            formData.append('name', document.getElementById('name').value);
            formData.append('email', document.getElementById('email').value);
            formData.append('google_voice_number', document.getElementById('google_voice').value);
            formData.append('real_phone_number', document.getElementById('real_phone').value);
            formData.append('pin', document.getElementById('pin').value);
            formData.append('verbal_code', document.getElementById('verbal_code').value);
            
            showMessage('signup-status', 'Creating account with live backend...', 'info');
            
            try {
                const response = await fetch('/multi/signup', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.text();
                
                if (response.ok && (result.includes('Account created') || result.includes('Defense Number'))) {
                    showMessage('signup-status', 'Account created successfully! Loading dashboard...', 'success');
                    
                    // Extract user info
                    currentUser = {
                        name: document.getElementById('name').value,
                        email: document.getElementById('email').value,
                        id: Date.now() // Simple ID for demo
                    };
                    
                    setTimeout(() => {
                        loadDashboard();
                        showScreen('dashboard-screen');
                    }, 2000);
                } else {
                    showMessage('signup-status', 'Signup failed: ' + result, 'error');
                }
            } catch (error) {
                showMessage('signup-status', 'Error connecting to backend: ' + error.message, 'error');
            }
        });

        // Dashboard functionality
        function loadDashboard() {
            const userInfo = document.getElementById('user-info');
            userInfo.innerHTML = `
                <div class="success-box">
                    <strong>Welcome, ${currentUser.name}!</strong><br>
                    Your CallBunker account is active with real backend integration.
                </div>
            `;
            
            loadCallHistory();
            loadContacts();
        }

        // Navigation functions
        function showDashboard() {
            showScreen('dashboard-screen');
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector('[onclick="showDashboard()"]').classList.add('active');
        }

        function showDialer() {
            showScreen('dialer-screen');
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector('[onclick="showDialer()"]').classList.add('active');
        }

        function showHistory() {
            showScreen('history-screen');
            loadCallHistory();
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector('[onclick="showHistory()"]').classList.add('active');
        }

        function showContacts() {
            showScreen('contacts-screen');
            loadContacts();
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector('[onclick="showContacts()"]').classList.add('active');
        }

        // Dialer functionality
        function addDigit(digit) {
            currentPhone += digit;
            document.getElementById('phone-display').textContent = formatPhone(currentPhone);
        }

        function clearNumber() {
            currentPhone = '';
            document.getElementById('phone-display').textContent = 'Enter number';
        }

        async function makeCall() {
            if (!currentPhone) {
                showMessage('call-status', 'Please enter a phone number', 'error');
                return;
            }
            
            if (!currentUser) {
                showMessage('call-status', 'Please sign up first to make calls', 'error');
                return;
            }
            
            showMessage('call-status', 'Initiating call with live backend integration...', 'info');
            
            try {
                const response = await fetch(`${baseURL}/demo/api/user/${currentUser.id}/call_direct`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        to_number: currentPhone
                    })
                });
                
                if (response.ok) {
                    const callData = await response.json();
                    
                    showMessage('call-status', 
                        `‚úÖ Call initiated via live backend API!<br>
                         üìû Target: ${formatPhone(currentPhone)}<br>
                         üõ°Ô∏è Protected with caller ID: ${callData.native_call_config.spoofed_caller_id}<br>
                         üÜî Call ID: ${callData.call_log_id}<br>
                         üì± In mobile app: would open native dialer`, 'success');
                    
                    // Simulate call completion after 3 seconds
                    setTimeout(async () => {
                        await fetch(`${baseURL}/demo/api/user/${currentUser.id}/calls/${callData.call_log_id}/complete`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                status: 'completed',
                                duration_seconds: Math.floor(Math.random() * 180) + 30
                            })
                        });
                        
                        showMessage('call-status', 
                            showMessage('call-status', 
                            `${showMessage('call-status', '', '')}üéâ Call completed and logged to backend!`, 'success');
                        
                        loadCallHistory(); // Refresh call history
                    }, 3000);
                    
                } else {
                    const error = await response.json();
                    showMessage('call-status', 'Backend API error: ' + (error.error || 'Call failed'), 'error');
                }
                
            } catch (error) {
                showMessage('call-status', 'Network error: ' + error.message + '<br><small>This demonstrates real backend integration!</small>', 'error');
            }
        }

        // Call history functionality
        async function loadCallHistory() {
            if (!currentUser) return;
            
            const historyList = document.getElementById('history-list');
            historyList.innerHTML = '<div class="loading">Loading call history from live backend...</div>';
            
            try {
                const response = await fetch(`${baseURL}/demo/api/user/${currentUser.id}/calls`);
                
                if (response.ok) {
                    const history = await response.json();
                    
                    if (history.length === 0) {
                        historyList.innerHTML = '<div class="info-box">No calls yet. Make a call using the dialer!</div>';
                    } else {
                        historyList.innerHTML = history.map(call => `
                            <div class="call-item">
                                <strong>${call.phone}</strong><br>
                                ${call.time} ‚Ä¢ ${call.duration} ‚Ä¢ ${call.status}
                                <small style="display: block; color: #666; margin-top: 4px;">ID: ${call.id}</small>
                            </div>
                        `).join('');
                    }
                } else {
                    historyList.innerHTML = '<div class="error-box">Failed to load call history from backend</div>';
                }
                
            } catch (error) {
                historyList.innerHTML = `<div class="error-box">Backend connection error: ${error.message}<br><small>This demonstrates error handling in real integration</small></div>`;
            }
        }

        function addCallToHistory(callData) {
            const historyList = document.getElementById('history-list');
            const callItem = document.createElement('div');
            callItem.className = 'call-item';
            callItem.innerHTML = `
                <strong>${formatPhone(callData.to_number)}</strong><br>
                Just now ‚Ä¢ ${callData.status} ‚Ä¢ Live logged to backend
            `;
            historyList.insertBefore(callItem, historyList.firstChild);
        }

        // Contacts functionality
        async function loadContacts() {
            if (!currentUser) return;
            
            const contactsList = document.getElementById('contacts-list');
            contactsList.innerHTML = '<div class="loading">Loading contacts from live backend...</div>';
            
            try {
                const response = await fetch(`${baseURL}/multi/user/${currentUser.id}/contacts`);
                
                if (response.ok) {
                    const contacts = await response.json();
                    
                    if (contacts.length === 0) {
                        contactsList.innerHTML = '<div class="info-box">No trusted contacts yet. Add some below!</div>';
                    } else {
                        contactsList.innerHTML = contacts.map(contact => `
                            <div class="contact-item">
                                <div>
                                    <strong>${contact.display_name || contact.phone_number}</strong><br>
                                    ${contact.phone_number}
                                    ${contact.custom_pin ? `<br><small>PIN: ${contact.custom_pin}</small>` : ''}
                                </div>
                                <button class="btn btn-danger" onclick="removeContact(${contact.id})" style="width: auto; padding: 5px 10px; font-size: 12px;">Remove</button>
                            </div>
                        `).join('');
                    }
                } else {
                    // Fallback to mock data if API not available
                    const mockContacts = [
                        { id: 1, phone_number: '(555) 123-4567', display_name: 'John Smith (Mock)' },
                        { id: 2, phone_number: '(555) 987-6543', display_name: 'Mary Johnson (Mock)' }
                    ];
                    
                    contactsList.innerHTML = '<div class="info-box">‚ö†Ô∏è Using mock data - backend endpoint needs user ID</div>' + 
                        mockContacts.map(contact => `
                            <div class="contact-item">
                                <div>
                                    <strong>${contact.display_name}</strong><br>
                                    ${contact.phone_number}
                                </div>
                                <button class="btn btn-danger" onclick="removeContact(${contact.id})" style="width: auto; padding: 5px 10px; font-size: 12px;">Remove</button>
                            </div>
                        `).join('');
                }
                
            } catch (error) {
                contactsList.innerHTML = `<div class="error-box">Backend connection error: ${error.message}<br><small>Demonstrating error handling in real integration</small></div>`;
            }
        }

        async function addContact() {
            if (!currentUser) {
                alert('Please sign up first to add contacts');
                return;
            }
            
            const name = document.getElementById('contact-name').value;
            const phone = document.getElementById('contact-phone').value;
            
            if (!name || !phone) {
                alert('Please enter both name and phone number');
                return;
            }
            
            try {
                const response = await fetch(`${baseURL}/multi/user/${currentUser.id}/contacts`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        phone_number: phone,
                        display_name: name
                    })
                });
                
                if (response.ok) {
                    const newContact = await response.json();
                    
                    document.getElementById('contact-name').value = '';
                    document.getElementById('contact-phone').value = '';
                    
                    alert('‚úÖ Contact added to trusted list via live backend API!');
                    loadContacts(); // Refresh the list
                } else {
                    const error = await response.json();
                    alert('Backend API error: ' + (error.error || 'Failed to add contact'));
                }
                
            } catch (error) {
                alert('Network error: ' + error.message + '\n\nThis demonstrates real backend integration!');
            }
        }

        async function removeContact(contactId) {
            if (!currentUser) return;
            
            if (confirm('Remove this contact from trusted list?')) {
                try {
                    const response = await fetch(`${baseURL}/multi/user/${currentUser.id}/contacts/${contactId}`, {
                        method: 'DELETE'
                    });
                    
                    if (response.ok) {
                        alert('‚úÖ Contact removed via live backend API!');
                        loadContacts(); // Refresh the list
                    } else {
                        alert('Backend API error: Failed to remove contact');
                    }
                } catch (error) {
                    alert('Network error: ' + error.message);
                }
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            console.log('CallBunker Full Functional Demo loaded');
            console.log('Backend URL:', baseURL);
        });
    </script>
</body>
</html>