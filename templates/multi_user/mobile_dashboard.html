<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>{{ user.name }}'s CallBunker</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            background: #f8f9fa;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            padding-bottom: 70px; /* Space for fixed tab bar */
        }
        
        .header {
            background: white;
            padding: 20px;
            text-align: center;
            border-bottom: 1px solid #eee;
        }
        
        .header h1 {
            color: #1c1c1e;
            font-size: 20px;
            font-weight: 600;
        }
        
        .content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }
        
        .screen {
            display: none;
        }
        
        .screen.active {
            display: block;
        }
        
        .card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .stats {
            display: flex;
            justify-content: space-around;
            text-align: center;
        }
        
        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #007aff;
        }
        
        .stat-label {
            font-size: 12px;
            color: #8e8e93;
            margin-top: 4px;
        }
        
        .actions {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin-top: 20px;
        }
        
        .action-btn {
            background: white;
            border: none;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            cursor: pointer;
        }
        
        .action-btn:active {
            transform: scale(0.95);
        }
        
        .action-icon {
            font-size: 28px;
            margin-bottom: 8px;
        }
        
        .action-title {
            font-size: 14px;
            font-weight: 600;
            color: #1c1c1e;
        }
        
        .action-subtitle {
            font-size: 12px;
            color: #8e8e93;
            margin-top: 4px;
        }
        
        /* Security Analytics Screen */
        .analytics-header {
            text-align: center;
            padding: 40px 20px 30px;
            background: white;
        }
        
        .analytics-shield {
            font-size: 48px;
            color: #007aff;
            margin-bottom: 16px;
        }
        
        .analytics-title {
            font-size: 24px;
            font-weight: 600;
            color: #1c1c1e;
            margin-bottom: 8px;
        }
        
        .analytics-subtitle {
            font-size: 14px;
            color: #8e8e93;
        }
        
        .stats-section {
            background: white;
            padding: 20px;
            margin: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .stats-title {
            font-size: 12px;
            color: #8e8e93;
            font-weight: 600;
            letter-spacing: 0.5px;
            margin-bottom: 20px;
            text-transform: uppercase;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            text-align: center;
        }
        
        .stat-item {
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        .stat-number-large {
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 4px;
        }
        
        .stat-label-large {
            font-size: 14px;
            color: #8e8e93;
        }
        
        .stat-green { color: #34c759; }
        .stat-blue { color: #007aff; }
        .stat-orange { color: #ff9500; }
        .stat-red { color: #ff3b30; }
        
        .effectiveness-section {
            background: white;
            padding: 20px;
            margin: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .effectiveness-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .effectiveness-item:last-child {
            margin-bottom: 0;
        }
        
        .effectiveness-label {
            font-size: 16px;
            font-weight: 500;
            color: #1c1c1e;
        }
        
        .effectiveness-percentage {
            font-size: 16px;
            font-weight: 600;
            color: #34c759;
        }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #f2f2f7;
            border-radius: 4px;
            margin-top: 8px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: #34c759;
            border-radius: 4px;
            transition: width 0.3s ease;
        }
        
        .activity-section {
            background: white;
            padding: 20px;
            margin: 20px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .activity-item {
            display: flex;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #f2f2f7;
        }
        
        .activity-item:last-child {
            border-bottom: none;
        }
        
        .activity-icon {
            width: 40px;
            height: 40px;
            border-radius: 20px;
            background: #ff3b30;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            font-size: 18px;
            color: white;
        }
        
        .activity-content {
            flex: 1;
        }
        
        .activity-title {
            font-size: 16px;
            font-weight: 500;
            color: #1c1c1e;
            margin-bottom: 2px;
        }
        
        .activity-time {
            font-size: 12px;
            color: #8e8e93;
        }
        
        .back-button {
            position: absolute;
            left: 20px;
            top: 20px;
            background: none;
            border: none;
            font-size: 18px;
            color: #007aff;
            cursor: pointer;
            padding: 8px;
        }

        /* Messages Screen */
        .messages-center {
            text-align: center;
            padding: 60px 20px;
        }
        
        .message-icon {
            font-size: 64px;
            margin-bottom: 16px;
            color: #c7c7cc;
        }
        
        .message-title {
            font-size: 24px;
            font-weight: 600;
            color: #1c1c1e;
            margin-bottom: 12px;
        }
        
        .message-subtitle {
            font-size: 16px;
            color: #8e8e93;
            line-height: 1.4;
        }
        
        /* Dialer */
        .dialer-container {
            height: 100%;
            display: flex;
            flex-direction: column;
            padding: 16px;
        }
        
        .dialer-display {
            text-align: center;
            padding: 16px;
            background: white;
            border-radius: 12px;
            margin-bottom: 16px;
        }
        
        .phone-number {
            font-size: 28px;
            color: #1c1c1e;
            margin-bottom: 8px;
            min-height: 35px;
        }
        
        .privacy-badge {
            background: #e8f5e8;
            color: #4caf50;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            display: inline-block;
        }
        
        .dialpad {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 20px;
            flex: 1;
            align-content: center;
        }
        
        .dial-btn {
            height: 60px;
            width: 60px;
            justify-self: center;
            background: white;
            border: none;
            border-radius: 50%;
            font-size: 20px;
            font-weight: 300;
            color: #1c1c1e;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .dial-btn:active {
            transform: scale(0.95);
        }
        
        .dial-letters {
            font-size: 8px;
            color: #8e8e93;
            margin-top: -2px;
        }
        
        .call-actions {
            display: flex;
            justify-content: center;
            gap: 20px;
            align-items: center;
            padding-bottom: 10px;
        }
        
        .call-btn {
            width: 55px;
            height: 55px;
            border-radius: 28px;
            border: none;
            background: #4caf50;
            color: white;
            font-size: 22px;
            cursor: pointer;
        }
        
        .call-btn:active {
            transform: scale(0.95);
        }
        
        .hangup-btn {
            width: 55px;
            height: 55px;
            border-radius: 28px;
            border: none;
            background: #f44336;
            color: white;
            font-size: 22px;
            cursor: pointer;
            margin-left: 10px;
        }
        
        .hangup-btn:active {
            transform: scale(0.95);
        }
        
        .speaker-btn {
            width: 50px;
            height: 50px;
            border-radius: 25px;
            border: none;
            background: #f2f2f7;
            color: #8e8e93;
            font-size: 18px;
            cursor: pointer;
            margin-left: 10px;
            transition: all 0.2s ease;
        }
        
        .speaker-btn.active {
            background: #34c759;
            color: white;
        }
        
        .speaker-btn:active {
            transform: scale(0.95);
        }
        
        .back-btn {
            width: 45px;
            height: 45px;
            border-radius: 23px;
            border: none;
            background: #f2f2f7;
            color: #ff3b30;
            font-size: 18px;
            cursor: pointer;
        }
        
        .back-btn:active {
            transform: scale(0.95);
        }
        
        /* List Items */
        .list-item {
            background: white;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            cursor: pointer;
        }
        
        .list-item:active {
            transform: scale(0.98);
        }
        
        .list-avatar {
            width: 40px;
            height: 40px;
            border-radius: 20px;
            background: #f2f2f7;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            font-size: 18px;
        }
        
        .list-content {
            flex: 1;
        }
        
        .list-title {
            font-size: 16px;
            font-weight: 500;
            color: #1c1c1e;
        }
        
        .list-subtitle {
            font-size: 14px;
            color: #8e8e93;
            margin-top: 2px;
        }
        
        .list-meta {
            font-size: 14px;
            color: #4caf50;
            font-weight: 500;
        }
        
        .list-arrow {
            color: #c7c7cc;
            font-size: 16px;
        }
        
        /* Detail Views */
        .detail-screen {
            display: none;
            padding: 16px;
        }
        
        .detail-screen.active {
            display: block;
        }
        
        .detail-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .back-arrow {
            background: none;
            border: none;
            font-size: 20px;
            color: #007aff;
            cursor: pointer;
            margin-right: 12px;
        }
        
        .detail-title {
            font-size: 18px;
            font-weight: 600;
            color: #1c1c1e;
        }
        
        .detail-card {
            background: white;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
        }
        
        .detail-label {
            font-size: 12px;
            color: #8e8e93;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }
        
        .detail-value {
            font-size: 16px;
            color: #1c1c1e;
            font-weight: 500;
        }
        
        .feature-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        
        .feature-item {
            padding: 8px 0;
            border-bottom: 1px solid #f2f2f7;
            display: flex;
            align-items: center;
        }
        
        .feature-item:last-child {
            border-bottom: none;
        }
        
        .feature-icon {
            margin-right: 8px;
            color: #4caf50;
        }
        
        .feature-text {
            color: #1c1c1e;
            font-size: 14px;
        }
        
        /* Tab Bar */
        .tab-bar {
            background: white;
            border-top: 1px solid #eee;
            padding: 6px 0;
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 100;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
        }
        
        .tab {
            text-align: center;
            cursor: pointer;
            padding: 6px 2px;
        }
        
        .tab.active {
            color: #007aff;
        }
        
        .tab:not(.active) {
            color: #8e8e93;
        }
        
        /* Special styling for Whitelist tab when active */
        .tab[onclick*="switchTab('whitelist')"].active {
            background: #007aff !important;
            color: white !important;
            border-radius: 6px;
            padding: 6px 2px;
        }
        
        .tab[onclick*="switchTab('whitelist')"].active .tab-icon {
            color: white !important;
        }
        
        .tab[onclick*="switchTab('whitelist')"].active .tab-label {
            color: white !important;
        }
        
        .tab-icon {
            font-size: 18px;
            margin-bottom: 1px;
        }
        
        .tab-label {
            font-size: 9px;
            font-weight: 500;
        }

        /* Info Section */
        .info-section {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .info-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #f2f2f7;
        }
        
        .info-row:last-child {
            border-bottom: none;
        }
        
        .info-label {
            font-size: 14px;
            color: #8e8e93;
            font-weight: 500;
        }
        
        .info-value {
            font-size: 14px;
            color: #1c1c1e;
            font-weight: 600;
            font-family: monospace;
        }
    </style>
    <!-- Twilio SDK loading removed - using simplified approach -->
</head>
<body>
    <div class="header">
        <h1 id="screen-title">{{ user.name }}'s CallBunker</h1>
    </div>
    
    <div class="content">
        <!-- Home Screen -->
        <div class="screen active" id="home">
            <div class="card" onclick="showScreen('analytics')" style="cursor: pointer;">
                <div style="display: flex; align-items: center; margin-bottom: 16px;">
                    <div style="font-size: 32px; color: #4caf50; margin-right: 12px;">üõ°Ô∏è</div>
                    <div>
                        <div style="font-size: 18px; font-weight: 600; color: #1c1c1e;">Privacy Protected</div>
                    </div>
                </div>
                <div class="stats">
                    <div>
                        <div class="stat-number" id="blocked-calls-stat" style="color: #ff3b30;">0</div>
                        <div class="stat-label">Blocked Calls</div>
                    </div>
                    <div>
                        <div class="stat-number" id="trusted-contacts-stat" style="color: #4caf50;">{{ whitelist_count }}</div>
                        <div class="stat-label">Whitelist</div>
                    </div>
                </div>
            </div>
            
            <div class="actions">
                <button class="action-btn" onclick="showDetail('privacy')">
                    <div class="action-icon" style="color: #ff9500;">üë•</div>
                    <div class="action-title">Whitelist</div>
                    <div class="action-subtitle">Manage contacts</div>
                </button>
            </div>

        </div>
        
        <!-- Dialer Screen -->
        <div class="screen" id="dialer">
            <div class="dialer-container">
                <div class="dialer-display">
                    <div class="phone-number" id="phone-display">Enter number</div>
                    <div class="privacy-badge">üõ°Ô∏è Privacy Protected ‚Ä¢ üîä Touch Tones</div>
                    <div id="call-status" class="call-status" aria-live="polite" style="font-size: 14px; color: #007aff; margin-top: 8px; min-height: 20px;"></div>
                </div>
                
                <div class="dialpad">
                    <button class="dial-btn" onclick="addDigit('1')">1</button>
                    <button class="dial-btn" onclick="addDigit('2')">2<br><span class="dial-letters">ABC</span></button>
                    <button class="dial-btn" onclick="addDigit('3')">3<br><span class="dial-letters">DEF</span></button>
                    <button class="dial-btn" onclick="addDigit('4')">4<br><span class="dial-letters">GHI</span></button>
                    <button class="dial-btn" onclick="addDigit('5')">5<br><span class="dial-letters">JKL</span></button>
                    <button class="dial-btn" onclick="addDigit('6')">6<br><span class="dial-letters">MNO</span></button>
                    <button class="dial-btn" onclick="addDigit('7')">7<br><span class="dial-letters">PQRS</span></button>
                    <button class="dial-btn" onclick="addDigit('8')">8<br><span class="dial-letters">TUV</span></button>
                    <button class="dial-btn" onclick="addDigit('9')">9<br><span class="dial-letters">WXYZ</span></button>
                    <button class="dial-btn" onclick="addDigit('*')">*</button>
                    <button class="dial-btn" onclick="addDigit('0')">0<br><span class="dial-letters">+</span></button>
                    <button class="dial-btn" onclick="addDigit('#')">#</button>
                </div>
                
                <div class="call-actions">
                    <button class="back-btn" onclick="backspace()">‚å´</button>
                    <button class="call-btn" onclick="makeCall()">üìû</button>
                    <button id="speaker-btn" class="speaker-btn" onclick="toggleSpeaker()" style="display: none;" title="Toggle Speaker">üîä</button>
                    <button id="hangup-btn" class="hangup-btn" onclick="hangupCall()" style="display: none;">üìµ</button>
                </div>
            </div>
        </div>
        
        <!-- Messages Screen -->
        <div class="screen" id="messages">
            <div class="messages-center">
                <div class="message-icon">üí¨</div>
                <div class="message-title">SMS Coming Soon</div>
                <div class="message-subtitle">Secure messaging with privacy protection will be available shortly.</div>
            </div>
        </div>
        
        <!-- Whitelist Screen -->
        <div class="screen" id="whitelist">
            <div style="background: #e8f5e8; padding: 16px; border-radius: 12px; margin-bottom: 16px; display: flex; align-items: center;">
                <span style="color: #4caf50; font-size: 20px; margin-right: 8px;">üõ°Ô∏è</span>
                <span style="color: #4caf50; font-size: 14px;">Whitelisted contacts bypass screening</span>
            </div>
            
            <div style="margin-bottom: 12px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <div style="font-size: 16px; font-weight: 600; color: #1c1c1e;" id="whitelist-contacts-header">Whitelist Contacts ({{ whitelist_count }})</div>
                    <button onclick="showAddContactForm()" style="background: #007aff; color: white; border: none; border-radius: 6px; padding: 6px 12px; font-size: 12px;">Add Contact</button>
                </div>
            </div>
            
            <div id="whitelist-contacts-list">
                <!-- Whitelist contacts will be loaded here -->
                {% if whitelist and whitelist|length > 0 %}
                    {% for contact in whitelist %}
                    <div class="list-item">
                        <div class="list-avatar">{{ contact.name[0].upper() if contact.name else '?' }}</div>
                        <div class="list-content">
                            <div class="list-title">{{ contact.name or 'Unknown' }}</div>
                            <div class="list-subtitle">{{ format_phone(contact.phone_number) }}</div>
                        </div>
                        <button onclick="removeContact('{{ contact.phone_number }}')" style="background: none; border: none; color: #ff3b30; font-size: 18px; cursor: pointer; padding: 8px;">üóëÔ∏è</button>
                    </div>
                    {% endfor %}
                {% else %}
                    <div style="text-align: center; padding: 40px; color: #8e8e93;">
                        <div style="font-size: 48px; margin-bottom: 16px;">üë•</div>
                        <div style="font-size: 16px; font-weight: 600; margin-bottom: 8px;">No Whitelist Contacts</div>
                        <div style="font-size: 14px;">Add contacts to bypass call screening</div>
                    </div>
                {% endif %}
            </div>
        </div>
        
        <!-- History Screen -->
        <div class="screen" id="history">
            <div id="call-history-list">
                <!-- Call history will be loaded here -->
                <div style="text-align: center; padding: 40px; color: #8e8e93;">
                    Loading call history...
                </div>
            </div>
        </div>
        
        <!-- Contacts Screen (now in settings) -->
        <div class="screen" id="contacts" style="display: none;">
            <div style="background: #e8f5e8; padding: 16px; border-radius: 12px; margin-bottom: 16px; display: flex; align-items: center;">
                <span style="color: #4caf50; font-size: 20px; margin-right: 8px;">üõ°Ô∏è</span>
                <span style="color: #4caf50; font-size: 14px;">Trusted contacts bypass screening</span>
            </div>
            
            <div style="margin-bottom: 12px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <div style="font-size: 16px; font-weight: 600; color: #1c1c1e;" id="contacts-header">Trusted Contacts ({{ whitelist_count }})</div>
                    <button onclick="showAddContactForm()" style="background: #007aff; color: white; border: none; border-radius: 6px; padding: 6px 12px; font-size: 12px;">Add Contact</button>
                </div>
            </div>
            
        </div>
        
        <!-- Settings Screen -->
        <div class="screen" id="settings">
            <!-- Account Information -->
            <div class="info-section">
                <div style="font-size: 16px; font-weight: 600; color: #1c1c1e; margin-bottom: 12px;">Account Details</div>
                <div class="info-row">
                    <div class="info-label">Defense Number</div>
                    <div class="info-value">{{ format_phone(user.assigned_twilio_number) }}</div>
                </div>
                <div class="info-row">
                    <div class="info-label">Real Phone</div>
                    <div class="info-value">{{ format_phone(user.real_phone_number) }}</div>
                </div>
            </div>

            <div class="list-item" onclick="showDetail('security')">
                <div class="list-avatar">üõ°Ô∏è</div>
                <div class="list-content">
                    <div class="list-title">Security Settings</div>
                    <div class="list-subtitle">PIN: {{ user.pin }}, Verbal: "{{ user.verbal_code }}"</div>
                </div>
                <div class="list-arrow">‚Ä∫</div>
            </div>
            <div class="list-item" onclick="showDetail('privacy')">
                <div class="list-avatar">üîí</div>
                <div class="list-content">
                    <div class="list-title">Privacy Protection</div>
                    <div class="list-subtitle">Call Screening & Authentication</div>
                </div>
                <div class="list-arrow">‚Ä∫</div>
            </div>
            <div class="list-item" onclick="showDetail('about')">
                <div class="list-avatar">‚ÑπÔ∏è</div>
                <div class="list-content">
                    <div class="list-title">About CallBunker</div>
                    <div class="list-subtitle">Version 1.0.0</div>
                </div>
                <div class="list-arrow">‚Ä∫</div>
            </div>
        </div>
        
        <!-- Security Analytics Screen -->
        <div class="screen" id="analytics">
            <div class="analytics-header">
                <button class="back-button" onclick="showScreen('home')">‚Üê</button>
                <div class="analytics-shield">üõ°Ô∏è</div>
                <div class="analytics-title">Privacy Protection Active</div>
                <div class="analytics-subtitle">Your real number stays completely hidden</div>
            </div>
            
            <!-- Call Statistics Section -->
            <div class="stats-section">
                <div class="stats-title">Call Statistics (Last 30 Days)</div>
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-number-large stat-green" id="protected-calls">14</div>
                        <div class="stat-label-large">Protected Calls</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number-large stat-blue" id="total-calls">20</div>
                        <div class="stat-label-large">Total Calls</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number-large stat-orange" id="screened-calls">12</div>
                        <div class="stat-label-large">Screened Calls</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number-large stat-red" id="blocked-attempts">{{ blocked_calls_count }}</div>
                        <div class="stat-label-large">Blocked Attempts</div>
                    </div>
                </div>
            </div>
            
            <!-- Protection Effectiveness Section -->
            <div class="effectiveness-section">
                <div class="stats-title">Protection Effectiveness</div>
                <div class="effectiveness-item">
                    <div class="effectiveness-label">Privacy Success Rate</div>
                    <div class="effectiveness-percentage">70%</div>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: 70%;"></div>
                </div>
                <div class="effectiveness-item" style="margin-top: 20px;">
                    <div class="effectiveness-label">Authentication Rate</div>
                    <div class="effectiveness-percentage">71%</div>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: 71%;"></div>
                </div>
            </div>
            
            <!-- Recent Activity Section -->
            <div class="activity-section">
                <div class="stats-title">Recent Activity</div>
                <div id="recent-activity">
                    <!-- Recent activity will be loaded here -->
                    <div class="activity-item">
                        <div class="activity-icon">üö´</div>
                        <div class="activity-content">
                            <div class="activity-title">Blocked call from (555) 999-8888</div>
                            <div class="activity-time">2 hours ago</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Security Detail Screen -->
        <div class="detail-screen" id="security-detail">
            <div class="detail-header">
                <button class="back-arrow" onclick="hideDetail()">‚Äπ</button>
                <div class="detail-title">Security Settings</div>
            </div>
            
            <div class="detail-card">
                <div class="detail-label">PIN Authentication</div>
                <div style="display: flex; align-items: center; margin-top: 8px;" id="pin-display">
                    <div style="flex: 1; padding: 8px; background: #f8f9fa; border-radius: 6px; font-size: 16px; margin-right: 8px; color: #1c1c1e;" id="pin-value">{{ user.pin }}</div>
                    <button onclick="editPin()" style="background: #007aff; color: white; border: none; border-radius: 6px; padding: 8px 12px; font-size: 14px;">Edit</button>
                </div>
                <div style="display: none; align-items: center; margin-top: 8px;" id="pin-edit">
                    <input type="text" id="pin-input" value="{{ user.pin }}" style="flex: 1; padding: 8px; border: 1px solid #e5e5ea; border-radius: 6px; font-size: 16px; margin-right: 8px;">
                    <button onclick="savePin()" style="background: #4caf50; color: white; border: none; border-radius: 6px; padding: 8px 12px; font-size: 14px; margin-right: 4px;">Save</button>
                    <button onclick="cancelPinEdit()" style="background: #8e8e93; color: white; border: none; border-radius: 6px; padding: 8px 12px; font-size: 14px;">Cancel</button>
                </div>
            </div>
            
            <div class="detail-card">
                <div class="detail-label">Verbal Authentication</div>
                <div style="display: flex; align-items: center; margin-top: 8px;" id="verbal-display">
                    <div style="flex: 1; padding: 8px; background: #f8f9fa; border-radius: 6px; font-size: 16px; margin-right: 8px; color: #1c1c1e;" id="verbal-value">"{{ user.verbal_code }}"</div>
                    <button onclick="editVerbal()" style="background: #007aff; color: white; border: none; border-radius: 6px; padding: 8px 12px; font-size: 14px;">Edit</button>
                </div>
                <div style="display: none; align-items: center; margin-top: 8px;" id="verbal-edit">
                    <input type="text" id="verbal-input" value="{{ user.verbal_code }}" style="flex: 1; padding: 8px; border: 1px solid #e5e5ea; border-radius: 6px; font-size: 16px; margin-right: 8px;">
                    <button onclick="saveVerbal()" style="background: #4caf50; color: white; border: none; border-radius: 6px; padding: 8px 12px; font-size: 14px; margin-right: 4px;">Save</button>
                    <button onclick="cancelVerbalEdit()" style="background: #8e8e93; color: white; border: none; border-radius: 6px; padding: 8px 12px; font-size: 14px;">Cancel</button>
                </div>
            </div>
        </div>

        <!-- Privacy Detail Screen -->
        <div class="detail-screen" id="privacy-detail">
            <div class="detail-header">
                <button class="back-arrow" onclick="hideDetail()">‚Äπ</button>
                <div class="detail-title">Privacy Protection</div>
            </div>
            
            <div class="detail-card">
                <div class="detail-label">CallBunker Defense System</div>
                <ul class="feature-list">
                    <li class="feature-item">
                        <span class="feature-icon">üõ°Ô∏è</span>
                        <span class="feature-text">Real number always hidden</span>
                    </li>
                    <li class="feature-item">
                        <span class="feature-icon">üîç</span>
                        <span class="feature-text">Automatic call screening</span>
                    </li>
                    <li class="feature-item">
                        <span class="feature-icon">üö´</span>
                        <span class="feature-text">Spam call blocking</span>
                    </li>
                    <li class="feature-item">
                        <span class="feature-icon">üë•</span>
                        <span class="feature-text">Trusted contact bypass</span>
                    </li>
                </ul>
            </div>
            
            <!-- Whitelist Management -->
            <div class="detail-card">
                <div class="detail-label">Whitelist Management</div>
                <div id="contacts-list">
                    <!-- Whitelisted contacts will be loaded here -->
                    <div style="text-align: center; padding: 40px; color: #8e8e93;">
                        Loading whitelist...
                    </div>
                </div>
                
                <!-- Add Contact Button -->
                <div style="margin-top: 16px;">
                    <button onclick="showAddContactForm()" style="width: 100%; background: #007aff; color: white; border: none; border-radius: 8px; padding: 12px; font-size: 16px; font-weight: 600;">
                        Add to Whitelist
                    </button>
                </div>
            </div>
        </div>

        <!-- About Detail Screen -->
        <div class="detail-screen" id="about-detail">
            <div class="detail-header">
                <button class="back-arrow" onclick="hideDetail()">‚Äπ</button>
                <div class="detail-title">About CallBunker</div>
            </div>
            
            <div class="detail-card">
                <div class="detail-label">Version</div>
                <div class="detail-value">CallBunker 1.0.0</div>
            </div>

            <div class="detail-card">
                <div class="detail-label">Your Account</div>
                <div style="margin-top: 8px;">
                    <div style="font-size: 14px; color: #1c1c1e; margin-bottom: 4px;">{{ user.name }}</div>
                    <div style="font-size: 12px; color: #8e8e93;">{{ user.email }}</div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="tab-bar">
        <div class="tab active" onclick="switchTab('home')">
            <div class="tab-icon">üè†</div>
            <div class="tab-label">Home</div>
        </div>
        <div class="tab" onclick="switchTab('dialer')">
            <div class="tab-icon">üìû</div>
            <div class="tab-label">Dialer</div>
        </div>
        <div class="tab" onclick="switchTab('messages')">
            <div class="tab-icon">üí¨</div>
            <div class="tab-label">Messages</div>
        </div>
        <div class="tab" onclick="switchTab('whitelist')">
            <div class="tab-icon">üë•</div>
            <div class="tab-label">Whitelist</div>
        </div>
        <div class="tab" onclick="switchTab('history')">
            <div class="tab-icon">üìã</div>
            <div class="tab-label">History</div>
        </div>
        <div class="tab" onclick="switchTab('settings')">
            <div class="tab-icon">‚öôÔ∏è</div>
            <div class="tab-label">Settings</div>
        </div>
    </div>

    <!-- Custom Modal Overlay -->
    <div id="modal-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
        <div id="modal-content" style="background: white; border-radius: 12px; padding: 24px; margin: 20px; max-width: 320px; text-align: center; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
            <div id="modal-title" style="font-size: 18px; font-weight: 600; color: #1c1c1e; margin-bottom: 12px;"></div>
            <div id="modal-message" style="font-size: 14px; color: #8e8e93; margin-bottom: 24px; line-height: 1.4;"></div>
            <div id="modal-buttons" style="display: flex; gap: 12px;">
                <!-- Buttons will be inserted here -->
            </div>
        </div>
    </div>

    <!-- Add Twilio Voice SDK from jsDelivr CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@twilio/voice-sdk@2.11.0/dist/twilio.min.js"></script>

    <script>
        // Global variables
        let phoneNumber = '';
        let audioContext;
        let twilioDevice = null;
        let currentCall = null;
        let currentPhoneNumber = ''; // Properly declare the variable
        let deviceReady = false;
        let tokenRefreshTimer = null;
        let speakerMode = false; // Track speaker mode state
        let currentAudioElement = null; // Track audio element for speaker toggle
        let previousScreen = 'home'; // Track where we came from for proper back navigation
        const USER_ID = {{ user.id }};
        
        // Safe DOM helpers
        function $(id) { return document.getElementById(id); }
        function setText(id, text) {
            const el = $(id);
            if (!el) {
                console.warn('Missing element:', id);
                return;
            }
            el.textContent = text;
        }
        function setHTML(id, html) {
            const el = $(id);
            if (!el) {
                console.warn('Missing element:', id);
                return;
            }
            el.innerHTML = html;
        }
        
        // Global error handler to catch any remaining DOM issues
        window.addEventListener('error', (e) => {
            console.error('GlobalError:', e.filename, e.lineno, e.message);
        });
        
        // Initialize CallBunker Voice System with Latest Twilio Voice SDK
        async function initializeTwilioVoice() {
            console.log('Initializing CallBunker Voice System...');
            
            try {
                // Check if Twilio SDK is loaded
                if (typeof Twilio === 'undefined') {
                    throw new Error('Twilio is not defined. Please refresh page.');
                }
                
                // Check if Twilio.Device is available
                if (typeof Twilio.Device === 'undefined') {
                    throw new Error('Twilio.Device is not available. Please refresh page.');
                }
                
                // Get voice token from backend
                const response = await fetch(`/multi/user/${USER_ID}/voice_token`, {
                    headers: {
                        'X-API-Key': 'demo-key-callbunker-2025',
                        'X-CSRF-Token': 'demo-csrf-callbunker'
                    }
                });
                const data = await response.json();
                
                if (!data.success) {
                    throw new Error(data.error || 'Failed to get voice token');
                }
                
                console.log('Voice token received, setting up Twilio Device...');
                
                // Clear any existing device
                if (twilioDevice) {
                    twilioDevice.destroy();
                    twilioDevice = null;
                }
                
                // Create new Twilio Device with latest SDK v2.x (proper string codec preferences)
                twilioDevice = new Twilio.Device(data.access_token, {
                    codecPreferences: ["opus", "pcmu"],
                    enableRingingState: true,
                    logLevel: 'error',
                    // Audio constraints for echo cancellation AND earpiece mode
                    audioConstraints: {
                        optional: [
                            { echoCancellation: true },
                            { noiseSuppression: true },
                            { autoGainControl: true },
                            { googEchoCancellation: true },
                            { googAutoGainControl: true },
                            { googNoiseSuppression: true },
                            { googHighpassFilter: true },
                            { googAudioMirroring: false }
                        ]
                    },
                    // Disable ringtones and notification sounds
                    sounds: {
                        outgoing: false,
                        incoming: false,
                        disconnect: false
                    }
                });
                
                // Device registration events (these fire for v2.x)
                twilioDevice.on('registered', () => {
                    console.log('Twilio Device registered successfully');
                    // In v2.x, device is ready when registered
                    deviceReady = true;
                    setText('call-status', 'Voice Ready');
                    showCustomAlert('Voice Ready', 'CallBunker no-callback calling is ready! Only target phones will ring.');
                });
                
                twilioDevice.on('unregistered', () => {
                    console.log('Twilio Device unregistered');
                    deviceReady = false;
                });
                
                // Keep ready event for compatibility
                twilioDevice.on('ready', () => {
                    console.log('Twilio Device ready event fired');
                    deviceReady = true;
                    setText('call-status', 'Voice Ready');
                });
                
                // Device error event
                twilioDevice.on('error', (error) => {
                    console.error('Twilio Device error:', error);
                    deviceReady = false;
                    setText('call-status', 'Voice Error');
                    showCustomAlert('Voice Error', `Voice system error: ${error.message}. Please refresh page.`);
                });
                
                // Token expiry events for robust token management
                twilioDevice.on('tokenWillExpire', async () => {
                    console.log('Token will expire, refreshing...');
                    await refreshVoiceToken();
                });
                
                twilioDevice.on('tokenExpired', async () => {
                    console.log('Token expired, refreshing...');
                    await refreshVoiceToken();
                });
                
                // Network resilience events
                twilioDevice.on('reconnecting', () => {
                    console.log('Device reconnecting...');
                    setText('call-status', 'Reconnecting...');
                });
                
                twilioDevice.on('reconnected', () => {
                    console.log('Device reconnected');
                    setText('call-status', 'Voice Ready');
                });
                
                // Call events with better debugging
                twilioDevice.on('connect', (call) => {
                    console.log('‚úÖ Call connected successfully!');
                    currentCall = call;
                    setText('call-status', 'Connected');
                    
                    // Show hangup and speaker buttons, hide call button during active call
                    document.getElementById('hangup-btn').style.display = 'inline-block';
                    document.getElementById('speaker-btn').style.display = 'inline-block';
                    document.querySelector('.call-btn').style.display = 'none';
                    
                    // Force earpiece mode immediately (UI state)
                    speakerMode = false;
                    const speakerBtn = document.getElementById('speaker-btn');
                    if (speakerBtn) {
                        speakerBtn.classList.remove('active');
                        speakerBtn.textContent = 'üîä';
                        speakerBtn.title = 'Switch to Speaker';
                        console.log('üîä Speaker button forced to earpiece mode (gray)');
                    }
                    
                    // Setup audio with retry mechanism for better timing
                    async function setupAudio(attempt = 1) {
                        console.log(`üîä Audio setup attempt ${attempt}`);
                        
                        try {
                            if (call.getRemoteStream) {
                                const remoteStream = call.getRemoteStream();
                                console.log('üîä Remote stream available:', !!remoteStream);
                                
                                if (remoteStream) {
                                    const audioElement = document.createElement('audio');
                                    audioElement.srcObject = remoteStream;
                                    audioElement.autoplay = true;
                                    audioElement.volume = 1.0;
                                    audioElement.id = 'call-audio';
                                    
                                    // Essential mobile attributes
                                    audioElement.setAttribute('playsinline', true);
                                    audioElement.setAttribute('webkit-playsinline', true);
                                    
                                    // Store reference for speaker toggle
                                    currentAudioElement = audioElement;
                                    
                                    // Check if device audio switching is supported
                                    const supportsAudioSwitching = !!(audioElement.setSinkId && navigator.mediaDevices);
                                    console.log('üîä setSinkId supported:', !!audioElement.setSinkId);
                                    console.log('üîä mediaDevices supported:', !!navigator.mediaDevices);
                                    
                                    if (supportsAudioSwitching) {
                                        // Desktop/supported browsers - try to route to earpiece
                                        navigator.mediaDevices.enumerateDevices().then(devices => {
                                            const audioOutputs = devices.filter(device => device.kind === 'audiooutput');
                                            console.log('üîä Audio switching supported -', audioOutputs.length, 'devices available');
                                            
                                            if (audioOutputs.length > 1) {
                                                // Multiple devices available - try to find earpiece
                                                const earpiece = audioOutputs.find(device => 
                                                    device.label && 
                                                    (device.label.toLowerCase().includes('earpiece') || 
                                                     device.label.toLowerCase().includes('phone') ||
                                                     device.label.toLowerCase().includes('receiver'))
                                                );
                                                
                                                if (earpiece) {
                                                    audioElement.setSinkId(earpiece.deviceId).then(() => {
                                                        console.log('üîä Audio routed to earpiece device');
                                                    }).catch(err => {
                                                        console.log('üîä Earpiece routing failed:', err.message);
                                                    });
                                                } else {
                                                    console.log('üîä No earpiece device found, using default audio output');
                                                }
                                            } else {
                                                console.log('üîä Only one audio device available, using default output');
                                            }
                                        }).catch(err => {
                                            console.log('üîä Device enumeration failed:', err.message);
                                        });
                                    } else {
                                        // Mobile browsers - limited audio control but force UI state
                                        console.log('üîä Mobile browser detected - limited audio routing (will use device default)');
                                        console.log('üîä Speaker mode forced OFF for mobile compatibility');
                                    }
                                    
                                    document.body.appendChild(audioElement);
                                    console.log('üîä Audio element created and attached to DOM');
                                    return true; // Success
                                } else if (attempt < 3) {
                                    // Retry if stream not available yet
                                    console.log(`üîä Remote stream not ready, retrying in 200ms (attempt ${attempt}/3)`);
                                    setTimeout(() => setupAudio(attempt + 1), 200);
                                } else {
                                    console.log('üîä Failed to get remote stream after 3 attempts');
                                }
                            } else {
                                console.log('üîä getRemoteStream method not available');
                            }
                        } catch (err) {
                            console.log('üîä Audio setup error:', err.message);
                        }
                        
                        return false; // Failed
                    }
                    
                    // Start audio setup
                    setupAudio();
                });
                
                twilioDevice.on('disconnect', (call) => {
                    console.log('üìû Call disconnected');
                    currentCall = null;
                    setText('call-status', 'Voice Ready');
                    
                    // Hide hangup and speaker buttons, show call button again
                    document.getElementById('hangup-btn').style.display = 'none';
                    document.getElementById('speaker-btn').style.display = 'none';
                    document.querySelector('.call-btn').style.display = 'inline-block';
                    
                    // Clean up audio element
                    if (currentAudioElement) {
                        currentAudioElement.remove();
                        currentAudioElement = null;
                    }
                });
                
                // Add more event handlers for debugging
                twilioDevice.on('cancel', (call) => {
                    console.log('‚ùå Call was cancelled');
                    currentCall = null;
                    setText('call-status', 'Call cancelled');
                    document.getElementById('hangup-btn').style.display = 'none';
                    document.getElementById('speaker-btn').style.display = 'none';
                    document.querySelector('.call-btn').style.display = 'inline-block';
                });
                
                twilioDevice.on('reject', (call) => {
                    console.log('üö´ Call was rejected');
                    currentCall = null;
                    setText('call-status', 'Call rejected');
                    document.getElementById('hangup-btn').style.display = 'none';
                    document.getElementById('speaker-btn').style.display = 'none';
                    document.querySelector('.call-btn').style.display = 'inline-block';
                });
                
                // Register the device
                await twilioDevice.register();
                
                // Set up token refresh (tokens expire in ~1 hour)
                if (tokenRefreshTimer) {
                    clearTimeout(tokenRefreshTimer);
                }
                tokenRefreshTimer = setTimeout(refreshVoiceToken, 50 * 60 * 1000); // Refresh after 50 minutes
                
                console.log('Twilio Device registration complete, waiting for ready event...');
                
            } catch (error) {
                console.error('Voice SDK initialization error:', error);
                deviceReady = false;
                twilioDevice = null;
                showCustomAlert('Initialization Error', `Could not initialize Voice system: ${error.message}. Please refresh page.`);
            }
        }
        
        // Refresh voice token (event-driven + fallback timer)
        async function refreshVoiceToken() {
            try {
                console.log('Refreshing voice token...');
                const response = await fetch(`/multi/user/${USER_ID}/voice_token`, {
                    headers: {
                        'X-API-Key': 'demo-key-callbunker-2025',
                        'X-CSRF-Token': 'demo-csrf-callbunker'
                    }
                });
                const data = await response.json();
                
                if (data.success && twilioDevice) {
                    await twilioDevice.updateToken(data.access_token);
                    console.log('Voice token refreshed successfully');
                } else {
                    console.error('Failed to refresh token, re-initializing...');
                    await initializeTwilioVoice();
                }
            } catch (error) {
                console.error('Token refresh error:', error);
                // Try full re-initialization on refresh failure
                await initializeTwilioVoice();
            }
        }
        
        // DTMF frequencies for each button
        const dtmfTones = {
            '1': [697, 1209], '2': [697, 1336], '3': [697, 1477],
            '4': [770, 1209], '5': [770, 1336], '6': [770, 1477],
            '7': [852, 1209], '8': [852, 1336], '9': [852, 1477],
            '*': [941, 1209], '0': [941, 1336], '#': [941, 1477]
        };
        
        const titles = {
            home: "{{ user.name }}'s CallBunker",
            dialer: 'Protected Dialer',
            messages: 'Messages',
            whitelist: 'Whitelist',
            history: 'Call History',
            settings: 'Settings'
        };
        
        // Initialize audio context
        function initAudio() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
        }
        
        // Play DTMF tone for dialer button
        function playDTMFTone(digit) {
            initAudio();
            
            if (!dtmfTones[digit]) return;
            
            const [lowFreq, highFreq] = dtmfTones[digit];
            const duration = 0.15; // 150ms tone duration
            
            // Create oscillators for the two frequencies
            const oscillator1 = audioContext.createOscillator();
            const oscillator2 = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            // Set frequencies
            oscillator1.frequency.setValueAtTime(lowFreq, audioContext.currentTime);
            oscillator2.frequency.setValueAtTime(highFreq, audioContext.currentTime);
            
            // Set gain (volume)
            gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration);
            
            // Connect the audio graph
            oscillator1.connect(gainNode);
            oscillator2.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            // Start and stop the tone
            oscillator1.start(audioContext.currentTime);
            oscillator2.start(audioContext.currentTime);
            oscillator1.stop(audioContext.currentTime + duration);
            oscillator2.stop(audioContext.currentTime + duration);
        }
        
        function switchTab(tab) {
            // Hide all screens and detail screens
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.detail-screen').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            
            // Show selected screen
            const screenElement = document.getElementById(tab);
            if (screenElement) {
                screenElement.classList.add('active');
            }
            
            // Update tab appearance - find by onclick attribute
            const tabElement = document.querySelector(`[onclick*="switchTab('${tab}')"]`);
            if (tabElement) {
                tabElement.classList.add('active');
            }
            
            // Update title
            const tabTitle = titles[tab] || 'CallBunker';
            setText('screen-title', tabTitle);
            
            // Load data when switching to certain tabs
            if (tab === 'history') {
                loadCallHistory();
            } else if (tab === 'home') {
                loadAnalytics();
            } else if (tab === 'whitelist') {
                loadContacts();
            }
            
            return false;
        }
        
        function showScreen(screenId) {
            // Hide all screens and detail screens
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.detail-screen').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            
            // Show selected screen
            document.getElementById(screenId).classList.add('active');
            
            // Update title based on screen
            if (screenId === 'analytics') {
                setText('screen-title', 'Security Analytics');
                loadAnalyticsData();
            } else if (screenId === 'home') {
                setText('screen-title', '{{ user.name }}\'s CallBunker');
                // Reactivate home tab
                document.querySelector(`[onclick="switchTab('home')"]`).classList.add('active');
                loadAnalytics();
            }
            
            return false;
        }
        
        function addDigit(digit) {
            // Play DTMF tone
            playDTMFTone(digit);
            
            phoneNumber += digit;
            updateDisplay();
        }
        
        function backspace() {
            if (phoneNumber.length > 0) {
                // Play a subtle click sound for backspace
                initAudio();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
                gainNode.gain.setValueAtTime(0.05, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.1);
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.1);
                
                phoneNumber = phoneNumber.slice(0, -1);
                updateDisplay();
            }
        }
        
        function updateDisplay() {
            const display = $('phone-display');
            if (!display) {
                console.error('phone-display element not found');
                return;
            }
            if (phoneNumber) {
                setText('phone-display', formatPhone(phoneNumber));
                display.style.color = '#1c1c1e';
            } else {
                setText('phone-display', 'Enter number');
                display.style.color = '#c7c7cc';
            }
        }
        
        function formatPhone(number) {
            const cleaned = number.replace(/\D/g, '');
            const match = cleaned.match(/^(\d{0,3})(\d{0,3})(\d{0,4})$/);
            if (match) {
                return [match[1], match[2], match[3]].filter(Boolean).join('-');
            }
            return number;
        }
        
        function normalizePhoneNumber(phoneNumber) {
            // Remove all non-digit characters
            const digits = phoneNumber.replace(/\D/g, '');
            
            // Handle different phone number formats
            if (digits.length === 10) {
                // US number without country code
                return '+1' + digits;
            } else if (digits.length === 11 && digits.startsWith('1')) {
                // US number with country code
                return '+' + digits;
            } else if (digits.length === 11 && !digits.startsWith('1')) {
                // International number without + sign
                return '+' + digits;
            } else if (digits.length > 11) {
                // International number, keep as is with + prefix
                return '+' + digits;
            }
            
            // For numbers that don't fit standard patterns, assume US format
            if (digits.length >= 7) {
                return '+1' + digits;
            }
            
            return phoneNumber; // Return original if too short
        }
        
        async function makeCall() {
            if (!phoneNumber) {
                showCustomAlert('Enter Number', 'Please enter a phone number to call.');
                return;
            }
            
            // Normalize the phone number to prevent formatting issues
            const normalizedNumber = normalizePhoneNumber(phoneNumber);
            
            const confirmed = await showCustomConfirm(
                'Protected Call',
                `Call ${formatPhone(phoneNumber)}? Your CallBunker number will be shown as caller ID. Only target phone will ring.`,
                'Call Now',
                'Cancel'
            );
            
            if (confirmed) {
                try {
                    // Check if Twilio Device is ready
                    if (!deviceReady || !twilioDevice) {
                        console.log('Device not ready, initializing...');
                        setText('call-status', 'Initializing Voice...');
                        showCustomAlert('Initializing', 'Setting up no-callback calling system...');
                        
                        // Try to initialize and wait for ready
                        await initializeTwilioVoice();
                        
                        // Wait up to 10 seconds for device to be ready
                        let attempts = 0;
                        while (!deviceReady && attempts < 20) {
                            await new Promise(resolve => setTimeout(resolve, 500)); // Wait 500ms
                            attempts++;
                        }
                        
                        if (!deviceReady || !twilioDevice) {
                            setText('call-status', 'Voice SDK Error');
                            showCustomAlert('Voice SDK Error', 'Voice system not ready. Please refresh page and wait for "Voice Ready" message.');
                            return;
                        }
                    }
                    
                    // Make the call using Twilio Device
                    console.log('üîÑ Making Voice SDK call to:', normalizedNumber);
                    setText('call-status', 'Calling...');
                    
                    const call = await twilioDevice.connect({
                        params: {
                            To: normalizedNumber
                        }
                    });
                    
                    console.log('üìû Call object created:', call);
                    currentCall = call;
                    
                    // IMMEDIATELY force earpiece mode when call is created (not waiting for connect)
                    speakerMode = false;
                    const speakerBtn = document.getElementById('speaker-btn');
                    if (speakerBtn) {
                        speakerBtn.classList.remove('active');
                        speakerBtn.textContent = 'üîä';
                        speakerBtn.title = 'Switch to Speaker';
                        console.log('üîä IMMEDIATE: Speaker button forced to earpiece mode (gray)');
                    }
                    
                    // Show hangup and speaker buttons immediately  
                    document.getElementById('hangup-btn').style.display = 'inline-block';
                    document.getElementById('speaker-btn').style.display = 'inline-block';
                    document.querySelector('.call-btn').style.display = 'none';
                    console.log('üîä IMMEDIATE: Call UI updated for earpiece mode');
                    
                    // Centralized call cleanup function
                    function cleanupCall(reason = 'unknown') {
                        console.log('üìû Cleaning up call due to:', reason);
                        
                        // Clear call reference
                        currentCall = null;
                        
                        // Reset status
                        setText('call-status', 'Voice Ready');
                        
                        // Reset UI elements
                        const hangupBtn = document.getElementById('hangup-btn');
                        const speakerBtn = document.getElementById('speaker-btn');
                        const callBtn = document.querySelector('.call-btn');
                        
                        if (hangupBtn) hangupBtn.style.display = 'none';
                        if (speakerBtn) speakerBtn.style.display = 'none';
                        if (callBtn) callBtn.style.display = 'inline-block';
                        
                        // Clean up audio element
                        if (currentAudioElement) {
                            try {
                                currentAudioElement.pause();
                                currentAudioElement.srcObject = null;
                                currentAudioElement.remove();
                            } catch (err) {
                                console.log('Audio cleanup error:', err.message);
                            }
                            currentAudioElement = null;
                        }
                        
                        // Reset speaker mode
                        speakerMode = false;
                        if (speakerBtn) {
                            speakerBtn.classList.remove('active');
                            speakerBtn.textContent = 'üîä';
                            speakerBtn.title = 'Switch to Speaker';
                        }
                    }

                    // Ensure speaker mode is OFF for new calls (earpiece default)
                    speakerMode = false;
                    const speakerBtn = document.getElementById('speaker-btn');
                    if (speakerBtn) {
                        speakerBtn.classList.remove('active');
                        speakerBtn.textContent = 'üîä';
                        speakerBtn.title = 'Switch to Speaker';
                    }
                    
                    // Add comprehensive disconnect listeners to handle all scenarios
                    call.on('disconnect', () => cleanupCall('remote disconnect'));
                    call.on('cancel', () => cleanupCall('call cancelled'));
                    call.on('error', (error) => {
                        console.log('üìû Call error:', error);
                        cleanupCall('call error');
                    });
                    
                    // Manually show hangup and speaker buttons while calling
                    document.getElementById('hangup-btn').style.display = 'inline-block';
                    document.getElementById('speaker-btn').style.display = 'inline-block';
                    document.querySelector('.call-btn').style.display = 'none';
                    
                    // Show calling status
                    showCustomAlert('Calling...', 'Target phone ringing. You will speak through this interface - no hold music!');
                    
                    // Clear the dialer
                    phoneNumber = '';
                    updateDisplay();
                    
                } catch (error) {
                    console.error('Voice SDK call error:', error);
                    setText('call-status', 'Call Error');
                    showCustomAlert('Call Error', `Failed to place call: ${error.message}. Please check your connection and try again.`);
                }
            }
        }
        
        function hangupCall() {
            if (currentCall) {
                console.log('üî¥ Hanging up call');
                currentCall.disconnect();
                setText('call-status', 'Hanging up...');
                
                // Reset UI immediately in case disconnect event doesn't fire
                setTimeout(() => {
                    document.getElementById('hangup-btn').style.display = 'none';
                    document.getElementById('speaker-btn').style.display = 'none';
                    document.querySelector('.call-btn').style.display = 'inline-block';
                    setText('call-status', 'Voice Ready');
                    currentCall = null;
                }, 1000);
            } else {
                console.log('No active call to hang up');
                // Reset UI state anyway
                document.getElementById('hangup-btn').style.display = 'none';
                document.querySelector('.call-btn').style.display = 'inline-block';
                setText('call-status', 'Voice Ready');
            }
        }
        
        // Call specific number from history or contacts
        async function callNumber(number) {
            console.log(`üìû Calling ${number} from history/contacts`);
            
            // Sanitize phone number (remove any potentially dangerous characters)
            const sanitizedNumber = number.replace(/[^+\d\-\(\)\s]/g, '');
            
            // Switch to dialer tab
            switchTab('dialer');
            
            // Set BOTH phone number variables so addDigit works correctly
            phoneNumber = sanitizedNumber.replace(/\D/g, ''); // Remove formatting for addDigit
            currentPhoneNumber = sanitizedNumber;
            
            console.log(`üìû Set phoneNumber to: "${phoneNumber}"`);
            console.log(`üìû Set currentPhoneNumber to: "${currentPhoneNumber}"`);
            
            // Update display properly
            updateDisplay();
            
            // Ensure Voice SDK is ready before calling
            if (!deviceReady || !twilioDevice) {
                console.log('üîÑ Voice SDK not ready, initializing...');
                setText('call-status', 'Preparing Voice...');
                
                try {
                    await initializeTwilioVoice();
                    
                    // Wait for device ready
                    let attempts = 0;
                    while (!deviceReady && attempts < 10) {
                        await new Promise(resolve => setTimeout(resolve, 500));
                        attempts++;
                    }
                    
                    if (!deviceReady) {
                        showCustomAlert('Voice Setup', 'Please tap the screen to activate voice calling, then try the Call button again.');
                        return;
                    }
                } catch (error) {
                    console.error('Failed to initialize Voice SDK:', error);
                    showCustomAlert('Voice Error', 'Please refresh the page and try again.');
                    return;
                }
            }
            
            // Now make the call
            makeCall();
        }
        
        // Toggle speaker mode during active call
        function toggleSpeaker() {
            if (!currentCall || !currentAudioElement) {
                console.log('No active call to toggle speaker');
                return;
            }
            
            speakerMode = !speakerMode;
            console.log(`üîä Toggling to ${speakerMode ? 'speaker' : 'earpiece'} mode`);
            
            // Update button appearance
            const speakerBtn = document.getElementById('speaker-btn');
            if (speakerMode) {
                speakerBtn.classList.add('active');
                speakerBtn.textContent = 'üîá'; // Mute icon when speaker is on
                speakerBtn.title = 'Switch to Earpiece';
            } else {
                speakerBtn.classList.remove('active');
                speakerBtn.textContent = 'üîä'; // Speaker icon when earpiece is on
                speakerBtn.title = 'Switch to Speaker';
            }
            
            // Update audio output
            if (currentAudioElement && currentAudioElement.setSinkId) {
                const deviceId = speakerMode ? 'default' : 'communications';
                currentAudioElement.setSinkId(deviceId).catch(err => {
                    console.log('Failed to change audio output:', err);
                    // Fallback: adjust volume as alternative
                    currentAudioElement.volume = speakerMode ? 1.0 : 0.8;
                });
            } else {
                // Fallback for browsers without setSinkId support
                if (currentAudioElement) {
                    currentAudioElement.volume = speakerMode ? 1.0 : 0.8;
                }
            }
            
            setText('call-status', `Connected ‚Ä¢ ${speakerMode ? 'Speaker' : 'Earpiece'}`);
        }
        
        // Event delegation for call and remove buttons
        function setupEventListeners() {
            // Call history buttons
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('call-history-btn')) {
                    e.stopPropagation();
                    const phoneNumber = e.target.getAttribute('data-number');
                    if (phoneNumber) {
                        callNumber(phoneNumber);
                    }
                }
                
                // Contact call buttons
                if (e.target.classList.contains('call-contact-btn')) {
                    e.stopPropagation();
                    const phoneNumber = e.target.getAttribute('data-number');
                    if (phoneNumber) {
                        callNumber(phoneNumber);
                    }
                }
                
                // Contact remove buttons
                if (e.target.classList.contains('remove-contact-btn')) {
                    e.stopPropagation();
                    const contactId = e.target.getAttribute('data-contact-id');
                    if (contactId) {
                        removeContact(parseInt(contactId));
                    }
                }
            });
        }
        
        // Load call history from API
        async function loadCallHistory() {
            try {
                const historyContainer = document.getElementById('call-history-list');
                if (!historyContainer) {
                    console.warn('call-history-list element not found');
                    return;
                }

                const response = await fetch(`/multi/user/${USER_ID}/calls`, {
                    headers: {
                        'X-API-Key': 'demo-key-callbunker-2025',
                        'X-CSRF-Token': 'demo-csrf-callbunker'
                    }
                });
                
                if (!response.ok) {
                    throw new Error('Failed to fetch call history');
                }
                
                const calls = await response.json();
                
                if (calls.length === 0) {
                    setHTML('call-history-list', `
                        <div style="text-align: center; padding: 40px; color: #8e8e93;">
                            <div style="font-size: 32px; margin-bottom: 12px;">üìû</div>
                            <div style="font-size: 16px; margin-bottom: 4px;">No Call History</div>
                            <div style="font-size: 14px;">Your protected calls will appear here</div>
                        </div>
                    `);
                    return;
                }
                
                // Clear and build history securely (reuse existing historyContainer variable)
                historyContainer.innerHTML = '';
                
                calls.forEach(call => {
                    const date = new Date(call.created_at);
                    const timeAgo = getTimeAgo(date);
                    const duration = call.duration_seconds ? formatDuration(call.duration_seconds) : '0:00';
                    const phoneNumber = call.direction === 'outbound' ? call.to_number : call.from_number;
                    
                    // Sanitize phone number for safe use
                    const sanitizedNumber = phoneNumber.replace(/[^+\d\-\(\)\s]/g, '');
                    
                    // Create elements safely
                    const listItem = document.createElement('div');
                    listItem.className = 'list-item';
                    
                    const avatar = document.createElement('div');
                    avatar.className = 'list-avatar';
                    avatar.textContent = call.direction === 'outbound' ? 'üìû' : 'üì±';
                    
                    const content = document.createElement('div');
                    content.className = 'list-content';
                    
                    const title = document.createElement('div');
                    title.className = 'list-title';
                    title.textContent = sanitizedNumber; // Safe text assignment
                    
                    const subtitle = document.createElement('div');
                    subtitle.className = 'list-subtitle';
                    subtitle.textContent = `${timeAgo} ‚Ä¢ ${call.status}`;
                    
                    const meta = document.createElement('div');
                    meta.className = 'list-meta';
                    meta.style.cssText = 'display: flex; align-items: center; gap: 8px;';
                    
                    const durationSpan = document.createElement('span');
                    durationSpan.style.cssText = 'color: #8e8e93; font-size: 12px;';
                    durationSpan.textContent = duration;
                    
                    const callBtn = document.createElement('button');
                    callBtn.className = 'call-history-btn';
                    callBtn.setAttribute('data-number', sanitizedNumber); // Safe attribute setting
                    callBtn.style.cssText = 'background: #4caf50; color: white; border: none; border-radius: 4px; padding: 4px 8px; font-size: 11px;';
                    callBtn.textContent = 'üìû Call';
                    
                    // Assemble elements
                    content.appendChild(title);
                    content.appendChild(subtitle);
                    meta.appendChild(durationSpan);
                    meta.appendChild(callBtn);
                    listItem.appendChild(avatar);
                    listItem.appendChild(content);
                    listItem.appendChild(meta);
                    historyContainer.appendChild(listItem);
                });
            } catch (error) {
                setHTML('call-history-list', `
                    <div style="text-align: center; padding: 40px; color: #ff3b30;">
                        Failed to load call history
                    </div>
                `);
            }
        }
        
        // Load contacts from API
        async function loadContacts() {
            try {
                const contactsList = document.getElementById('contacts-list');
                const contactsHeader = document.getElementById('contacts-header');
                
                if (!contactsList || !contactsHeader) {
                    console.warn('contacts DOM elements not found');
                    return;
                }

                const response = await fetch(`/multi/user/${USER_ID}/contacts`, {
                    headers: {
                        'X-API-Key': 'demo-key-callbunker-2025',
                        'X-CSRF-Token': 'demo-csrf-callbunker'
                    }
                });
                
                if (!response.ok) {
                    throw new Error('Failed to fetch contacts');
                }
                
                const contacts = await response.json();
                
                contactsHeader.textContent = `Trusted Contacts (${contacts.length})`;
                
                if (contacts.length === 0) {
                    setHTML('contacts-list', `
                        <div style="text-align: center; padding: 40px; color: #8e8e93;">
                            <div style="font-size: 32px; margin-bottom: 12px;">üë•</div>
                            <div style="font-size: 16px; margin-bottom: 4px;">No Trusted Contacts</div>
                            <div style="font-size: 14px;">Add contacts to bypass call screening</div>
                        </div>
                    `);
                    return;
                }
                
                // Clear and build contacts securely
                const contactsContainer = document.getElementById('contacts-list');
                contactsContainer.innerHTML = '';
                
                contacts.forEach(contact => {
                    const initials = getInitialsFromPhone(contact.display_name);
                    
                    // Sanitize phone number for safe use
                    const sanitizedNumber = contact.phone_number.replace(/[^+\d\-\(\)\s]/g, '');
                    
                    // Create elements safely
                    const listItem = document.createElement('div');
                    listItem.className = 'list-item contact-item';
                    listItem.setAttribute('data-contact-id', contact.id.toString());
                    
                    const avatar = document.createElement('div');
                    avatar.className = 'list-avatar';
                    avatar.style.cssText = 'background: #007aff; color: white; font-weight: 600;';
                    avatar.textContent = initials; // Safe text assignment
                    
                    const content = document.createElement('div');
                    content.className = 'list-content';
                    
                    const title = document.createElement('div');
                    title.className = 'list-title';
                    title.textContent = contact.display_name; // Safe text assignment
                    
                    const subtitle = document.createElement('div');
                    subtitle.className = 'list-subtitle';
                    subtitle.textContent = contact.custom_pin ? 'Custom PIN set' : 'Default settings';
                    
                    const actions = document.createElement('div');
                    actions.className = 'contact-actions';
                    actions.style.cssText = 'display: flex; gap: 4px;';
                    
                    const callBtn = document.createElement('button');
                    callBtn.className = 'call-contact-btn';
                    callBtn.setAttribute('data-number', sanitizedNumber); // Safe attribute setting
                    callBtn.style.cssText = 'background: #4caf50; color: white; border: none; border-radius: 4px; padding: 4px 8px; font-size: 11px;';
                    callBtn.textContent = 'üìû Call';
                    
                    const removeBtn = document.createElement('button');
                    removeBtn.className = 'remove-contact-btn';
                    removeBtn.setAttribute('data-contact-id', contact.id.toString());
                    removeBtn.style.cssText = 'background: #ff3b30; color: white; border: none; border-radius: 4px; padding: 4px 8px; font-size: 11px;';
                    removeBtn.textContent = 'Remove';
                    
                    // Assemble elements
                    content.appendChild(title);
                    content.appendChild(subtitle);
                    actions.appendChild(callBtn);
                    actions.appendChild(removeBtn);
                    listItem.appendChild(avatar);
                    listItem.appendChild(content);
                    listItem.appendChild(actions);
                    contactsContainer.appendChild(listItem);
                });
            } catch (error) {
                setHTML('contacts-list', `
                    <div style="text-align: center; padding: 40px; color: #ff3b30;">
                        Failed to load contacts
                    </div>
                `);
            }
        }
        
        // Load analytics from API
        async function loadAnalytics() {
            try {
                const blockedCallsStat = document.getElementById('blocked-calls-stat');
                const trustedContactsStat = document.getElementById('trusted-contacts-stat');
                
                if (!blockedCallsStat || !trustedContactsStat) {
                    console.warn('analytics DOM elements not found');
                    return;
                }

                const response = await fetch(`/multi/user/${USER_ID}/analytics`, {
                    headers: {
                        'X-API-Key': 'demo-key-callbunker-2025',
                        'X-CSRF-Token': 'demo-csrf-callbunker'
                    }
                });
                
                if (!response.ok) {
                    throw new Error('Failed to fetch analytics');
                }
                
                const analytics = await response.json();
                
                setText('blocked-calls-stat', analytics.blocked_calls);
                setText('trusted-contacts-stat', analytics.trusted_contacts);
            } catch (error) {
                console.error('Failed to load analytics:', error);
            }
        }
        
        async function removeContact(contactId) {
            const confirmed = await showCustomConfirm(
                'Remove Contact?',
                'This contact will no longer bypass call screening.',
                'Remove',
                'Cancel'
            );
            
            if (confirmed) {
                try {
                    const response = await fetch(`/multi/user/${USER_ID}/contacts/${contactId}`, {
                        method: 'DELETE',
                        headers: {
                            'X-API-Key': 'demo-key-callbunker-2025',
                            'X-CSRF-Token': 'demo-csrf-callbunker'
                        }
                    });
                    
                    if (response.ok) {
                        showCustomAlert('Removed', 'Contact has been removed from whitelist.');
                        loadContacts(); // Reload the contacts list
                        loadAnalytics(); // Update stats
                    } else {
                        showCustomAlert('Error', 'Failed to remove contact.');
                    }
                } catch (error) {
                    showCustomAlert('Error', 'Network error occurred.');
                }
            }
        }
        
        function showAddContactForm() {
            // Simple prompt for now - could be enhanced with a proper modal form
            const phoneNumber = prompt('Enter phone number for trusted contact:');
            if (phoneNumber && phoneNumber.trim()) {
                addContact(phoneNumber.trim());
            }
        }
        
        async function addContact(phoneNumber) {
            const normalizedPhone = normalizePhoneNumber(phoneNumber);
            
            try {
                const response = await fetch(`/multi/user/${USER_ID}/contacts`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-API-Key': 'demo-key-callbunker-2025',
                        'X-CSRF-Token': 'demo-csrf-callbunker'
                    },
                    body: JSON.stringify({
                        phone_number: normalizedPhone
                    })
                });
                
                if (response.ok) {
                    showCustomAlert('Added', 'Contact has been added to whitelist.');
                    loadContacts(); // Reload the contacts list
                    loadAnalytics(); // Update stats
                } else {
                    const error = await response.json();
                    showCustomAlert('Error', error.error || 'Failed to add contact.');
                }
            } catch (error) {
                showCustomAlert('Error', 'Network error occurred.');
            }
        }
        
        // Settings functions
        function showDetail(detailType) {
            // Track which screen we're coming from
            const currentActiveScreen = document.querySelector('.screen.active');
            if (currentActiveScreen) {
                previousScreen = currentActiveScreen.id;
            }
            
            // Hide all screens
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            
            // Show detail screen
            document.getElementById(detailType + '-detail').classList.add('active');
            
            // Update header title
            const titles = {
                security: 'Security Settings',
                privacy: 'Privacy Protection', 
                about: 'About CallBunker'
            };
            setText('screen-title', titles[detailType]);
            
            // Load contacts if showing privacy detail
            if (detailType === 'privacy') {
                loadContacts();
            }
            
            return false;
        }
        
        function hideDetail() {
            // Hide all detail screens
            document.querySelectorAll('.detail-screen').forEach(s => s.classList.remove('active'));
            
            // Return to the screen we came from
            const targetScreen = previousScreen || 'settings';
            document.getElementById(targetScreen).classList.add('active');
            
            // Update tab appearance
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            const targetTab = document.querySelector(`[onclick*="switchTab('${targetScreen}')"]`);
            if (targetTab) {
                targetTab.classList.add('active');
            }
            
            // Update header title based on target screen
            const targetTitle = titles[targetScreen] || 'CallBunker';
            setText('screen-title', targetTitle);
            
            // Load analytics if returning to home
            if (targetScreen === 'home') {
                loadAnalytics();
            }
            
            return false;
        }
        
        function editPin() {
            document.getElementById('pin-display').style.display = 'none';
            document.getElementById('pin-edit').style.display = 'flex';
            document.getElementById('pin-input').focus();
        }
        
        async function savePin() {
            const newPin = document.getElementById('pin-input').value;
            if (newPin && /^\d{4}$/.test(newPin)) {
                try {
                    const response = await fetch(`/multi/user/${USER_ID}/settings`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-API-Key': 'demo-key-callbunker-2025',
                            'X-CSRF-Token': 'demo-csrf-callbunker'
                        },
                        body: JSON.stringify({
                            pin: newPin
                        })
                    });
                    
                    if (response.ok) {
                        setText('pin-value', newPin);
                        document.getElementById('pin-display').style.display = 'flex';
                        document.getElementById('pin-edit').style.display = 'none';
                        showCustomAlert('PIN Updated', 'Your new PIN ' + newPin + ' will be used for call authentication.');
                        updateSettingsDisplay();
                    } else {
                        showCustomAlert('Error', 'Failed to update PIN.');
                    }
                } catch (error) {
                    showCustomAlert('Error', 'Network error occurred.');
                }
            } else {
                showCustomAlert('Invalid PIN', 'Please enter a valid 4-digit PIN number.');
                document.getElementById('pin-input').focus();
            }
        }
        
        function cancelPinEdit() {
            const currentPinEl = $('pin-value'); const currentPin = currentPinEl ? currentPinEl.textContent : '';
            document.getElementById('pin-input').value = currentPin;
            document.getElementById('pin-display').style.display = 'flex';
            document.getElementById('pin-edit').style.display = 'none';
        }
        
        function editVerbal() {
            document.getElementById('verbal-display').style.display = 'none';
            document.getElementById('verbal-edit').style.display = 'flex';
            document.getElementById('verbal-input').focus();
        }
        
        async function saveVerbal() {
            const newVerbal = document.getElementById('verbal-input').value.trim();
            if (newVerbal && newVerbal.length >= 3) {
                try {
                    const response = await fetch(`/multi/user/${USER_ID}/settings`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-API-Key': 'demo-key-callbunker-2025',
                            'X-CSRF-Token': 'demo-csrf-callbunker'
                        },
                        body: JSON.stringify({
                            verbal_code: newVerbal
                        })
                    });
                    
                    if (response.ok) {
                        document.getElementById('verbal-value').textContent = '"' + newVerbal + '"';
                        document.getElementById('verbal-display').style.display = 'flex';
                        document.getElementById('verbal-edit').style.display = 'none';
                        showCustomAlert('Verbal Code Updated', 'Your new code "' + newVerbal + '" will be used for voice authentication.');
                        updateSettingsDisplay();
                    } else {
                        showCustomAlert('Error', 'Failed to update verbal code.');
                    }
                } catch (error) {
                    showCustomAlert('Error', 'Network error occurred.');
                }
            } else {
                showCustomAlert('Invalid Code', 'Please enter a verbal code with at least 3 characters.');
                document.getElementById('verbal-input').focus();
            }
        }
        
        function cancelVerbalEdit() {
            const currentVerbal = document.getElementById('verbal-value').textContent.replace(/"/g, '');
            document.getElementById('verbal-input').value = currentVerbal;
            document.getElementById('verbal-display').style.display = 'flex';
            document.getElementById('verbal-edit').style.display = 'none';
        }
        
        function updateSettingsDisplay() {
            // Update the PIN and verbal code display in the main settings list
            const pinEl = $('pin-value'); const pin = pinEl ? pinEl.textContent : '';
            const verbalEl = $('verbal-value'); const verbal = verbalEl ? verbalEl.textContent.replace(/"/g, '') : '';
            
            // Find and update the settings subtitle
            const settingsItems = document.querySelectorAll('#settings .list-subtitle');
            settingsItems.forEach(item => {
                if (item.textContent.includes('PIN:')) {
                    item.textContent = `PIN: ${pin}, Verbal: "${verbal}"`;
                }
            });
        }
        
        function loadAnalyticsData() {
            // Update analytics screen with real data
            document.getElementById('blocked-attempts').textContent = document.getElementById('blocked-calls-stat').textContent;
            
            // Load recent activity from call history
            loadRecentActivity();
        }
        
        function loadRecentActivity() {
            // This would load recent blocked calls for the activity section
            // For now, we'll show the sample data that matches the mobile demo
            const activityDiv = document.getElementById('recent-activity');
            setHTML('recent-activity', `
                <div class="activity-item">
                    <div class="activity-icon">üö´</div>
                    <div class="activity-content">
                        <div class="activity-title">Blocked call from (555) 999-8888</div>
                        <div class="activity-time">2 hours ago</div>
                    </div>
                </div>
            `);
        }
        
        // Utility functions
        function getTimeAgo(date) {
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);
            
            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins}m ago`;
            if (diffHours < 24) return `${diffHours}h ago`;
            if (diffDays < 30) return `${diffDays}d ago`;
            return date.toLocaleDateString();
        }
        
        function formatDuration(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = seconds % 60;
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }
        
        function getInitialsFromPhone(phone) {
            // Extract digits and use last 2 digits as initials
            const digits = phone.replace(/\D/g, '');
            return digits.slice(-2) || 'XX';
        }
        
        // Modal functions
        function showCustomAlert(title, message) {
            return new Promise((resolve) => {
                const overlay = document.getElementById('modal-overlay');
                const titleEl = document.getElementById('modal-title');
                const messageEl = document.getElementById('modal-message');
                const buttonsEl = document.getElementById('modal-buttons');
                
                if (!overlay || !titleEl || !messageEl || !buttonsEl) {
                    console.error('Modal elements not found');
                    resolve();
                    return;
                }
                
                titleEl.textContent = title;
                messageEl.textContent = message;
                setHTML('modal-buttons', `
                    <button id="modal-ok-btn" style="flex: 1; background: #007aff; color: white; border: none; border-radius: 8px; padding: 12px; font-size: 16px; font-weight: 500;">OK</button>
                `);
                
                document.getElementById('modal-ok-btn').onclick = function() {
                    hideModal();
                    resolve();
                };
                
                overlay.style.display = 'flex';
                
                window.resolve = resolve;
            });
        }
        
        function showCustomConfirm(title, message, confirmText, cancelText) {
            return new Promise((resolve) => {
                const overlay = document.getElementById('modal-overlay');
                const titleEl = document.getElementById('modal-title');
                const messageEl = document.getElementById('modal-message');
                const buttonsEl = document.getElementById('modal-buttons');
                
                if (!overlay || !titleEl || !messageEl || !buttonsEl) {
                    console.error('Modal elements not found');
                    resolve(false);
                    return;
                }
                
                titleEl.textContent = title;
                messageEl.textContent = message;
                setHTML('modal-buttons', `
                    <button id="modal-cancel-btn" style="flex: 1; background: #8e8e93; color: white; border: none; border-radius: 8px; padding: 12px; font-size: 16px; font-weight: 500; margin-right: 8px;">${cancelText}</button>
                    <button id="modal-confirm-btn" style="flex: 1; background: #007aff; color: white; border: none; border-radius: 8px; padding: 12px; font-size: 16px; font-weight: 500;">${confirmText}</button>
                `);
                
                document.getElementById('modal-cancel-btn').onclick = function() {
                    hideModal();
                    window.modalResolve(false);
                };
                
                document.getElementById('modal-confirm-btn').onclick = function() {
                    hideModal();
                    window.modalResolve(true);
                };
                
                overlay.style.display = 'flex';
                
                window.modalResolve = resolve;
            });
        }
        
        function hideModal() {
            document.getElementById('modal-overlay').style.display = 'none';
        }
        
        // Add missing functions for settings
        function updatePin() { 
            showCustomAlert('Settings', 'PIN update feature coming soon!'); 
        }
        function updateVerbalCode() { 
            showCustomAlert('Settings', 'Verbal code update feature coming soon!'); 
        }

        // Expose functions globally for onclick handlers
        window.switchTab = switchTab;
        window.showScreen = showScreen;
        window.addDigit = addDigit;
        window.backspace = backspace;
        window.makeCall = makeCall;
        window.hangupCall = hangupCall;
        window.toggleSpeaker = toggleSpeaker;
        window.hideModal = hideModal;
        window.showAddContactForm = showAddContactForm;
        window.deleteContact = removeContact;  // Expose removeContact as deleteContact
        window.removeContact = removeContact;
        window.updatePin = updatePin;
        window.updateVerbalCode = updateVerbalCode;

        // Clean up device on page unload
        window.addEventListener('beforeunload', () => {
            if (twilioDevice) {
                try {
                    twilioDevice.unregister();
                    twilioDevice.destroy();
                } catch (error) {
                    console.log('Device cleanup error:', error);
                }
            }
        });
        
        // Wait for Twilio SDK to load with better debugging
        function waitForTwilio() {
            return new Promise((resolve, reject) => {
                let attempts = 0;
                const maxAttempts = 50; // 5 seconds max
                
                function checkTwilio() {
                    console.log(`Checking Twilio SDK... attempt ${attempts + 1}`);
                    console.log('typeof Twilio:', typeof Twilio);
                    if (typeof Twilio !== 'undefined') {
                        console.log('Twilio object found, checking Device...');
                        console.log('typeof Twilio.Device:', typeof Twilio.Device);
                        if (typeof Twilio.Device !== 'undefined') {
                            console.log('Twilio SDK loaded successfully');
                            resolve();
                            return;
                        }
                    }
                    
                    if (attempts < maxAttempts) {
                        attempts++;
                        setTimeout(checkTwilio, 100);
                    } else {
                        console.error('Twilio SDK failed to load after', maxAttempts, 'attempts');
                        console.log('window.Twilio:', window.Twilio);
                        console.log('Available globals:', Object.keys(window).filter(k => k.toLowerCase().includes('twilio')));
                        reject(new Error('Twilio SDK failed to load'));
                    }
                }
                
                checkTwilio();
            });
        }
        
        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', async function() {
            loadAnalytics();
            setupEventListeners(); // Initialize event delegation for call buttons
            
            try {
                // Wait for Twilio SDK to load first
                await waitForTwilio();
                
                // Initialize Voice SDK after first user interaction (required for microphone permissions)
                document.addEventListener('click', function initVoiceOnFirstClick() {
                    initializeTwilioVoice();
                    document.removeEventListener('click', initVoiceOnFirstClick);
                }, { once: true });
                
            } catch (error) {
                console.error('Failed to load Twilio SDK:', error);
                showCustomAlert('SDK Error', 'Failed to load Voice SDK. Please refresh page and try again.');
            }
        });
    </script>
</body>
</html>