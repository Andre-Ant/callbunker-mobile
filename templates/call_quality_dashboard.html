<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CallBunker Call Quality Monitor</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .quality-excellent { color: #28a745; }
        .quality-good { color: #17a2b8; }
        .quality-fair { color: #ffc107; }
        .quality-poor { color: #dc3545; }
        
        .metric-card {
            transition: all 0.3s ease;
            border-left: 4px solid #007bff;
        }
        
        .metric-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .metric-excellent { border-left-color: #28a745; }
        .metric-good { border-left-color: #17a2b8; }
        .metric-fair { border-left-color: #ffc107; }
        .metric-poor { border-left-color: #dc3545; }
        
        .alert-badge {
            position: relative;
            top: -2px;
        }
        
        .real-time-indicator {
            width: 12px;
            height: 12px;
            background: #28a745;
            border-radius: 50%;
            display: inline-block;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(40, 167, 69, 0); }
            100% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0); }
        }
        
        .quality-gauge {
            position: relative;
            width: 200px;
            height: 100px;
            margin: 0 auto;
        }
        
        .refresh-button {
            transition: transform 0.3s ease;
        }
        
        .refresh-button.spinning {
            transform: rotate(360deg);
        }
    </style>
</head>
<body class="bg-light">
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="bi bi-shield-check"></i> CallBunker Quality Monitor
            </a>
            <div class="navbar-nav ms-auto">
                <span class="navbar-text">
                    <span class="real-time-indicator"></span> Real-time Monitoring
                </span>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- User Selection -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">
                            <i class="bi bi-person-circle"></i> Select User
                        </h5>
                        <select class="form-select" id="userSelect" onchange="loadUserData()">
                            <option value="">Choose a user...</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">
                            <i class="bi bi-clock-history"></i> Time Period
                        </h5>
                        <select class="form-select" id="timePeriodSelect" onchange="loadUserData()">
                            <option value="1">Last 24 Hours</option>
                            <option value="3">Last 3 Days</option>
                            <option value="7" selected>Last 7 Days</option>
                            <option value="30">Last 30 Days</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quality Overview Cards -->
        <div class="row mb-4" id="overviewCards" style="display: none;">
            <div class="col-md-3">
                <div class="card metric-card">
                    <div class="card-body text-center">
                        <h5 class="card-title">
                            <i class="bi bi-telephone-fill"></i> Total Calls
                        </h5>
                        <h2 class="mb-1" id="totalCalls">-</h2>
                        <small class="text-muted">monitored calls</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card metric-card" id="mosCard">
                    <div class="card-body text-center">
                        <h5 class="card-title">
                            <i class="bi bi-speedometer2"></i> Avg MOS Score
                        </h5>
                        <h2 class="mb-1" id="avgMos">-</h2>
                        <small class="text-muted">out of 5.0</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card metric-card" id="latencyCard">
                    <div class="card-body text-center">
                        <h5 class="card-title">
                            <i class="bi bi-stopwatch"></i> Avg Latency
                        </h5>
                        <h2 class="mb-1" id="avgLatency">-</h2>
                        <small class="text-muted">milliseconds</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card metric-card" id="jitterCard">
                    <div class="card-body text-center">
                        <h5 class="card-title">
                            <i class="bi bi-graph-up-arrow"></i> Avg Jitter
                        </h5>
                        <h2 class="mb-1" id="avgJitter">-</h2>
                        <small class="text-muted">milliseconds</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quality Alerts -->
        <div class="row mb-4" id="alertsSection" style="display: none;">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">
                            <i class="bi bi-exclamation-triangle"></i> Quality Alerts
                            <span class="badge bg-danger alert-badge" id="alertCount">0</span>
                        </h5>
                        <button class="btn btn-sm btn-outline-primary refresh-button" onclick="loadUserData()">
                            <i class="bi bi-arrow-clockwise"></i> Refresh
                        </button>
                    </div>
                    <div class="card-body" id="alertsBody">
                        <p class="text-muted text-center">No active quality alerts</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Section -->
        <div class="row mb-4" id="chartsSection" style="display: none;">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="bi bi-pie-chart"></i> Quality Distribution
                        </h5>
                    </div>
                    <div class="card-body">
                        <canvas id="qualityDistributionChart" width="400" height="300"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="bi bi-graph-up"></i> MOS Score Trend
                        </h5>
                    </div>
                    <div class="card-body">
                        <canvas id="mosScoreTrendChart" width="400" height="300"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Calls Table -->
        <div class="row" id="recentCallsSection" style="display: none;">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="bi bi-list-ul"></i> Recent Call Quality Details
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Date/Time</th>
                                        <th>Quality</th>
                                        <th>MOS Score</th>
                                        <th>Latency</th>
                                        <th>Jitter</th>
                                        <th>Packet Loss</th>
                                        <th>Network</th>
                                        <th>User Rating</th>
                                    </tr>
                                </thead>
                                <tbody id="recentCallsBody">
                                    <tr>
                                        <td colspan="8" class="text-center text-muted">
                                            No call quality data available
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- User Feedback Modal -->
    <div class="modal fade" id="feedbackModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Rate Call Quality</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">How would you rate the call quality?</label>
                        <div class="rating-stars text-center mb-3">
                            <span class="star" data-rating="1">⭐</span>
                            <span class="star" data-rating="2">⭐</span>
                            <span class="star" data-rating="3">⭐</span>
                            <span class="star" data-rating="4">⭐</span>
                            <span class="star" data-rating="5">⭐</span>
                        </div>
                        <input type="hidden" id="selectedRating" value="">
                    </div>
                    <div class="mb-3">
                        <label for="feedbackText" class="form-label">Additional Comments (Optional)</label>
                        <textarea class="form-control" id="feedbackText" rows="3" 
                                  placeholder="Tell us about any issues you experienced..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="submitFeedback()">Submit Feedback</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentUserId = null;
        let currentCallLogId = null;
        let qualityChart = null;
        let mosChart = null;

        // Initialize the dashboard
        document.addEventListener('DOMContentLoaded', function() {
            loadUsers();
            
            // Add star rating functionality
            document.querySelectorAll('.star').forEach(star => {
                star.addEventListener('click', function() {
                    const rating = this.dataset.rating;
                    document.getElementById('selectedRating').value = rating;
                    updateStarDisplay(rating);
                });
            });
        });

        function loadUsers() {
            // In a real implementation, this would fetch from /api/users
            // For demo purposes, we'll use sample data
            const userSelect = document.getElementById('userSelect');
            const sampleUsers = [
                {id: 1, name: 'John Doe', email: 'john@example.com'},
                {id: 2, name: 'Jane Smith', email: 'jane@example.com'},
                {id: 3, name: 'Mike Johnson', email: 'mike@example.com'}
            ];
            
            sampleUsers.forEach(user => {
                const option = document.createElement('option');
                option.value = user.id;
                option.textContent = `${user.name} (${user.email})`;
                userSelect.appendChild(option);
            });
        }

        function loadUserData() {
            const userId = document.getElementById('userSelect').value;
            const days = document.getElementById('timePeriodSelect').value;
            
            if (!userId) {
                hideAllSections();
                return;
            }
            
            currentUserId = userId;
            
            // Add spinning animation to refresh button
            const refreshBtn = document.querySelector('.refresh-button');
            refreshBtn.classList.add('spinning');
            
            // Load quality summary
            fetch(`/quality/api/users/${userId}/quality/summary?days=${days}`)
                .then(response => response.json())
                .then(data => {
                    updateOverviewCards(data);
                    updateCharts(data);
                    updateRecentCallsTable(data.recent_metrics);
                    showAllSections();
                })
                .catch(error => {
                    console.error('Error loading quality data:', error);
                    showError('Failed to load quality data');
                })
                .finally(() => {
                    refreshBtn.classList.remove('spinning');
                });
            
            // Load quality alerts
            fetch(`/quality/api/users/${userId}/quality/alerts`)
                .then(response => response.json())
                .then(data => {
                    updateAlertsSection(data);
                })
                .catch(error => {
                    console.error('Error loading alerts:', error);
                });
        }

        function updateOverviewCards(data) {
            document.getElementById('totalCalls').textContent = data.total_calls || 0;
            
            // MOS Score
            if (data.average_mos) {
                document.getElementById('avgMos').textContent = data.average_mos;
                updateCardClass('mosCard', getMosQualityClass(data.average_mos));
            } else {
                document.getElementById('avgMos').textContent = 'N/A';
                updateCardClass('mosCard', 'metric');
            }
            
            // Latency
            if (data.average_latency) {
                document.getElementById('avgLatency').textContent = Math.round(data.average_latency);
                updateCardClass('latencyCard', getLatencyQualityClass(data.average_latency));
            } else {
                document.getElementById('avgLatency').textContent = 'N/A';
                updateCardClass('latencyCard', 'metric');
            }
            
            // Jitter
            if (data.average_jitter) {
                document.getElementById('avgJitter').textContent = Math.round(data.average_jitter);
                updateCardClass('jitterCard', getJitterQualityClass(data.average_jitter));
            } else {
                document.getElementById('avgJitter').textContent = 'N/A';
                updateCardClass('jitterCard', 'metric');
            }
        }

        function updateCardClass(cardId, qualityClass) {
            const card = document.getElementById(cardId);
            card.className = `card metric-card metric-${qualityClass}`;
        }

        function getMosQualityClass(mos) {
            if (mos >= 4.0) return 'excellent';
            if (mos >= 3.5) return 'good';
            if (mos >= 2.5) return 'fair';
            return 'poor';
        }

        function getLatencyQualityClass(latency) {
            if (latency <= 100) return 'excellent';
            if (latency <= 200) return 'good';
            if (latency <= 300) return 'fair';
            return 'poor';
        }

        function getJitterQualityClass(jitter) {
            if (jitter <= 20) return 'excellent';
            if (jitter <= 50) return 'good';
            if (jitter <= 100) return 'fair';
            return 'poor';
        }

        function updateAlertsSection(alerts) {
            const alertCount = document.getElementById('alertCount');
            const alertsBody = document.getElementById('alertsBody');
            
            alertCount.textContent = alerts.length;
            
            if (alerts.length === 0) {
                alertsBody.innerHTML = '<p class="text-muted text-center">No active quality alerts</p>';
                return;
            }
            
            const alertsHtml = alerts.map(alert => `
                <div class="alert alert-${getSeverityClass(alert.severity)} alert-dismissible" role="alert">
                    <i class="bi bi-exclamation-triangle-fill"></i>
                    <strong>${capitalizeFirst(alert.alert_type.replace('_', ' '))}:</strong> 
                    ${alert.message}
                    <small class="d-block mt-1">
                        ${alert.calls_affected} calls affected in the last ${alert.time_period_hours} hour(s)
                    </small>
                    <button type="button" class="btn btn-sm btn-outline-secondary mt-2" 
                            onclick="acknowledgeAlert(${alert.alert_id})">
                        Acknowledge
                    </button>
                </div>
            `).join('');
            
            alertsBody.innerHTML = alertsHtml;
        }

        function getSeverityClass(severity) {
            const map = {
                'low': 'info',
                'medium': 'warning', 
                'high': 'danger',
                'critical': 'danger'
            };
            return map[severity] || 'info';
        }

        function capitalizeFirst(str) {
            return str.charAt(0).toUpperCase() + str.slice(1);
        }

        function updateCharts(data) {
            updateQualityDistributionChart(data.quality_distribution);
            updateMosScoreTrendChart(data.recent_metrics);
        }

        function updateQualityDistributionChart(distribution) {
            const ctx = document.getElementById('qualityDistributionChart').getContext('2d');
            
            if (qualityChart) {
                qualityChart.destroy();
            }
            
            const labels = Object.keys(distribution);
            const values = Object.values(distribution);
            const colors = labels.map(label => {
                switch(label) {
                    case 'excellent': return '#28a745';
                    case 'good': return '#17a2b8';
                    case 'fair': return '#ffc107';
                    case 'poor': return '#dc3545';
                    default: return '#6c757d';
                }
            });
            
            qualityChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels.map(capitalizeFirst),
                    datasets: [{
                        data: values,
                        backgroundColor: colors,
                        borderWidth: 2,
                        borderColor: '#fff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }

        function updateMosScoreTrendChart(recentMetrics) {
            const ctx = document.getElementById('mosScoreTrendChart').getContext('2d');
            
            if (mosChart) {
                mosChart.destroy();
            }
            
            // Sort by date and take last 10 calls with MOS scores
            const mosData = recentMetrics
                .filter(m => m.mos_score !== null)
                .sort((a, b) => new Date(a.created_at) - new Date(b.created_at))
                .slice(-10);
            
            const labels = mosData.map(m => new Date(m.created_at).toLocaleString());
            const scores = mosData.map(m => m.mos_score);
            
            mosChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'MOS Score',
                        data: scores,
                        borderColor: '#007bff',
                        backgroundColor: 'rgba(0, 123, 255, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 5,
                            title: {
                                display: true,
                                text: 'MOS Score'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }

        function updateRecentCallsTable(recentMetrics) {
            const tbody = document.getElementById('recentCallsBody');
            
            if (!recentMetrics || recentMetrics.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">No call quality data available</td></tr>';
                return;
            }
            
            const rows = recentMetrics.slice(0, 20).map(metric => `
                <tr>
                    <td>${new Date(metric.created_at).toLocaleString()}</td>
                    <td>
                        <span class="badge bg-${getQualityBadgeClass(metric.quality_category)}">
                            ${capitalizeFirst(metric.quality_category || 'unknown')}
                        </span>
                    </td>
                    <td>${metric.mos_score ? metric.mos_score.toFixed(2) : 'N/A'}</td>
                    <td>${metric.latency_ms ? Math.round(metric.latency_ms) + 'ms' : 'N/A'}</td>
                    <td>${metric.jitter_ms ? Math.round(metric.jitter_ms) + 'ms' : 'N/A'}</td>
                    <td>${metric.packet_loss_percent ? metric.packet_loss_percent.toFixed(1) + '%' : 'N/A'}</td>
                    <td>
                        <span class="badge bg-secondary">
                            ${capitalizeFirst(metric.network_type || 'unknown')}
                        </span>
                    </td>
                    <td>
                        ${metric.user_rating ? 
                            '⭐'.repeat(metric.user_rating) + '☆'.repeat(5 - metric.user_rating) : 
                            '<button class="btn btn-sm btn-outline-primary" onclick="showFeedbackModal(' + metric.call_log_id + ')">Rate</button>'
                        }
                    </td>
                </tr>
            `).join('');
            
            tbody.innerHTML = rows;
        }

        function getQualityBadgeClass(category) {
            const map = {
                'excellent': 'success',
                'good': 'info',
                'fair': 'warning',
                'poor': 'danger'
            };
            return map[category] || 'secondary';
        }

        function showFeedbackModal(callLogId) {
            currentCallLogId = callLogId;
            const modal = new bootstrap.Modal(document.getElementById('feedbackModal'));
            modal.show();
        }

        function updateStarDisplay(selectedRating) {
            document.querySelectorAll('.star').forEach((star, index) => {
                const rating = index + 1;
                star.style.opacity = rating <= selectedRating ? '1' : '0.3';
            });
        }

        function submitFeedback() {
            const rating = document.getElementById('selectedRating').value;
            const feedback = document.getElementById('feedbackText').value;
            
            if (!rating) {
                alert('Please select a rating');
                return;
            }
            
            fetch(`/quality/api/users/${currentUserId}/calls/${currentCallLogId}/feedback`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    rating: parseInt(rating),
                    feedback: feedback
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    bootstrap.Modal.getInstance(document.getElementById('feedbackModal')).hide();
                    loadUserData(); // Refresh the data
                    showSuccess('Thank you for your feedback!');
                } else {
                    showError('Failed to submit feedback');
                }
            })
            .catch(error => {
                console.error('Error submitting feedback:', error);
                showError('Failed to submit feedback');
            });
        }

        function acknowledgeAlert(alertId) {
            fetch(`/quality/api/users/${currentUserId}/quality/alerts/${alertId}/acknowledge`, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    loadUserData(); // Refresh alerts
                    showSuccess('Alert acknowledged');
                } else {
                    showError('Failed to acknowledge alert');
                }
            })
            .catch(error => {
                console.error('Error acknowledging alert:', error);
                showError('Failed to acknowledge alert');
            });
        }

        function showAllSections() {
            document.getElementById('overviewCards').style.display = 'block';
            document.getElementById('alertsSection').style.display = 'block';
            document.getElementById('chartsSection').style.display = 'block';
            document.getElementById('recentCallsSection').style.display = 'block';
        }

        function hideAllSections() {
            document.getElementById('overviewCards').style.display = 'none';
            document.getElementById('alertsSection').style.display = 'none';
            document.getElementById('chartsSection').style.display = 'none';
            document.getElementById('recentCallsSection').style.display = 'none';
        }

        function showSuccess(message) {
            // Simple success notification - in production, use a proper toast library
            alert(message);
        }

        function showError(message) {
            // Simple error notification - in production, use a proper toast library
            alert(message);
        }

        // Auto-refresh every 30 seconds if a user is selected
        setInterval(() => {
            if (currentUserId) {
                loadUserData();
            }
        }, 30000);
    </script>
</body>
</html>