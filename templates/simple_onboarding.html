{% extends "base.html" %}

{% block title %}Get Started - CallBunker{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-lg-8">
        <!-- Header -->
        <div class="text-center mb-5">
            <h1 class="mb-3">
                <i class="fas fa-shield-alt me-3 text-primary"></i>Welcome to CallBunker
            </h1>
            <p class="lead text-body">Get a free phone number with built-in call screening</p>
            
            <div class="alert alert-info d-flex align-items-start mt-4" role="alert">
                <i class="fas fa-info-circle fa-lg me-3 mt-1"></i>
                <div class="text-start">
                    <strong>Perfect for New Phone Numbers:</strong> This setup gives you a completely new phone number with call screening built-in. Ideal for side projects, freelance work, online selling, dating apps, or any time you need a secondary number with spam protection.
                    <br><br>
                    <strong>Already have an established number people know?</strong> You'll need to decide whether to transition contacts to this new screened number or keep your current setup. This works best when you can give out the new TextNow number as your go-to contact number.
                </div>
            </div>
        </div>

        <!-- How It Works -->
        <div class="card border-info mb-4">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>How CallBunker Works</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3 text-center mb-3">
                        <div class="bg-light p-3 rounded">
                            <i class="fas fa-phone fa-2x text-primary mb-2"></i>
                            <h6>Get free TextNow number</h6>
                            <small class="text-body">New number to give out</small>
                        </div>
                    </div>
                    <div class="col-md-3 text-center mb-3">
                        <div class="bg-light p-3 rounded">
                            <i class="fas fa-arrow-right fa-2x text-info mb-2"></i>
                            <h6>TextNow forwards calls</h6>
                            <small class="text-body">To CallBunker screening</small>
                        </div>
                    </div>
                    <div class="col-md-3 text-center mb-3">
                        <div class="bg-light p-3 rounded">
                            <i class="fas fa-shield-alt fa-2x text-warning mb-2"></i>
                            <h6>CallBunker screens</h6>
                            <small class="text-body">Asks for PIN or verbal code</small>
                        </div>
                    </div>
                    <div class="col-md-3 text-center mb-3">
                        <div class="bg-light p-3 rounded">
                            <i class="fas fa-check-circle fa-2x text-success mb-2"></i>
                            <h6>Verified calls ring you</h6>
                            <small class="text-body">Spam gets blocked</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Step 1: Get TextNow Number -->
        <div class="card mb-4">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0"><i class="fas fa-mobile-alt me-2"></i>Step 1: Get Your Free TextNow Number</h5>
            </div>
            <div class="card-body">
                <div class="alert alert-info">
                    <i class="fas fa-gift me-2"></i>
                    <strong>Your New Screened Number:</strong> TextNow provides a free US phone number that you can give out when you want call screening protection. Perfect for online listings, dating apps, freelance work, or any situation where you want spam protection!
                </div>

                <div class="row mb-3">
                    <div class="col-md-6">
                        <h6><i class="fas fa-mobile-alt me-2"></i>Get TextNow (2 minutes):</h6>
                        <ol class="small">
                            <li>Visit <strong>textnow.com</strong> or download the app</li>
                            <li>Create a free account</li>
                            <li>Choose your area code</li>
                            <li>Get your free phone number</li>
                        </ol>
                        <a href="https://www.textnow.com" target="_blank" class="btn btn-primary btn-sm">
                            <i class="fas fa-external-link-alt me-1"></i>Open TextNow
                        </a>
                    </div>
                    <div class="col-md-6">
                        <h6><i class="fas fa-cog me-2"></i>Configure Call Forwarding:</h6>
                        <ol class="small">
                            <li>In TextNow, go to <strong>Settings</strong></li>
                            <li>Find <strong>Call Forwarding</strong> option</li>
                            <li>Forward to: <strong>+1 (631) 641-7727</strong></li>
                            <li>Save the settings</li>
                        </ol>
                        <button class="btn btn-outline-secondary btn-sm" onclick="copyToClipboard('+16316417727')">
                            <i class="fas fa-copy me-1"></i>Copy CallBunker Number
                        </button>
                    </div>
                </div>

                <div class="mb-3">
                    <label for="textnowNumber" class="form-label">Enter Your TextNow Number:</label>
                    <input type="tel" class="form-control" id="textnowNumber" 
                           placeholder="+1 (555) 123-4567" onchange="enableNextStep()">
                    <div class="form-text">This will be your new screened number that people can call</div>
                </div>

                <button class="btn btn-success" onclick="proceedToStep2()" id="step1Button" disabled>
                    <i class="fas fa-arrow-right me-2"></i>Continue to Step 2
                </button>
            </div>
        </div>

        <!-- Step 2: Configure CallBunker -->
        <div class="card" id="step2Card" style="display: none;">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0"><i class="fas fa-shield-alt me-2"></i>Step 2: Configure Your Call Screening</h5>
            </div>
            <div class="card-body">
                <form id="setupForm" onsubmit="createTenant(event)">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="phoneNumber" class="form-label">Your TextNow Number *</label>
                            <input type="tel" class="form-control" id="phoneNumber" name="screening_number" 
                                   readonly required>
                            <div class="form-text">The TextNow number people will call</div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="realPhone" class="form-label">Your Real Phone Number *</label>
                            <input type="tel" class="form-control" id="realPhone" name="forward_to" 
                                   placeholder="+1 (555) 987-6543" required>
                            <div class="form-text">Where screened calls will ring</div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="label" class="form-label">Label (Optional)</label>
                            <input type="text" class="form-control" id="label" name="owner_label" 
                                   placeholder="My Screened Line">
                            <div class="form-text">Just for your reference</div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="pin" class="form-label">PIN Code *</label>
                            <input type="text" class="form-control" id="pin" name="current_pin" 
                                   value="1122" pattern="[0-9]{4}" maxlength="4" required>
                            <div class="form-text">4-digit code legitimate callers will use</div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="verbal" class="form-label">Verbal Code *</label>
                            <input type="text" class="form-control" id="verbal" name="verbal_code" 
                                   value="open sesame" required>
                            <div class="form-text">Phrase callers can say instead of PIN</div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="pin" class="form-label">PIN Code *</label>
                            <input type="text" class="form-control" id="pin" name="current_pin" 
                                   value="1122" pattern="[0-9]{4}" maxlength="4" required>
                            <div class="form-text">4-digit code legitimate callers will use</div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="verbal" class="form-label">Verbal Code *</label>
                            <input type="text" class="form-control" id="verbal" name="verbal_code" 
                                   value="open sesame" required>
                            <div class="form-text">Phrase callers can say instead of PIN</div>
                        </div>
                    </div>

                    <!-- Hidden fields for defaults -->
                    <input type="hidden" name="forward_mode" value="bridge">
                    <input type="hidden" name="retry_limit" value="3">
                    <input type="hidden" name="rl_window_sec" value="1800">
                    <input type="hidden" name="rl_max_attempts" value="5">
                    <input type="hidden" name="rl_block_minutes" value="60">

                    <div class="d-grid">
                        <button type="submit" class="btn btn-success btn-lg">
                            <i class="fas fa-shield-alt me-2"></i>Create My Call Screening
                        </button>
                    </div>
                </form>
            </div>
        </div>


    </div>
</div>

<script>
function enableNextStep() {
    const textnowNumber = document.getElementById('textnowNumber').value.trim();
    const button = document.getElementById('step1Button');
    
    if (textnowNumber && textnowNumber.length >= 10) {
        button.disabled = false;
    } else {
        button.disabled = true;
    }
}

function proceedToStep2() {
    const textnowNumber = document.getElementById('textnowNumber').value.trim();
    
    // Hide step 1, show step 2
    document.querySelector('.card:first-of-type').style.display = 'none';
    document.getElementById('step2Card').style.display = 'block';
    
    // Fill in the TextNow number in step 2
    document.getElementById('phoneNumber').value = textnowNumber;
    
    // Scroll to step 2
    document.getElementById('step2Card').scrollIntoView({behavior: 'smooth'});
}

function createTenant(event) {
    event.preventDefault();
    
    const formData = new FormData(event.target);
    
    fetch('/admin/tenants', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Show success message
            showSuccessMessage(formData);
        } else {
            alert('Error creating tenant: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error creating tenant');
    });
}

function showSuccessMessage(formData) {
    const textnowNumber = formData.get('screening_number');
    const realPhone = formData.get('forward_to');
    const pin = formData.get('current_pin');
    const verbal = formData.get('verbal_code');
    
    // Hide step 2
    document.getElementById('step2Card').style.display = 'none';
    
    // Create and show success card
    const successHTML = `
        <div class="card border-success" id="successCard">
            <div class="card-header bg-success text-white">
                <h5 class="mb-0"><i class="fas fa-check-circle me-2"></i>Setup Complete!</h5>
            </div>
            <div class="card-body">
                <div class="alert alert-success">
                    <strong>Your CallBunker is now active!</strong>
                </div>
                
                <h6><i class="fas fa-phone me-2"></i>Your Setup Summary:</h6>
                <ul class="list-group list-group-flush mb-3">
                    <li class="list-group-item d-flex justify-content-between">
                        <span><strong>Public Number (TextNow):</strong></span>
                        <span>${textnowNumber}</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between">
                        <span><strong>Your Real Phone:</strong></span>
                        <span>${realPhone}</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between">
                        <span><strong>PIN Code:</strong></span>
                        <span>${pin}</span>
                    </li>
                    <li class="list-group-item d-flex justify-content-between">
                        <span><strong>Verbal Code:</strong></span>
                        <span>"${verbal}"</span>
                    </li>
                </ul>

                <div class="alert alert-info">
                    <h6><i class="fas fa-info-circle me-2"></i>How to Use:</h6>
                    <ol class="mb-0">
                        <li><strong>Give out your TextNow number</strong> (${textnowNumber}) to people</li>
                        <li><strong>When they call,</strong> they'll hear CallBunker ask for authentication</li>
                        <li><strong>They enter ${pin}</strong> or say "${verbal}" to reach you</li>
                        <li><strong>Spam callers</strong> who don't know the code get blocked</li>
                    </ol>
                </div>

                <div class="alert alert-warning">
                    <strong>Test it!</strong> Have someone call your TextNow number (${textnowNumber}) and try entering the PIN.
                </div>

                <div class="d-grid gap-2">
                    <a href="/admin" class="btn btn-success">
                        <i class="fas fa-tachometer-alt me-2"></i>Go to Dashboard
                    </a>
                    <button class="btn btn-outline-primary" onclick="location.reload()">
                        <i class="fas fa-plus me-2"></i>Set Up Another Number
                    </button>
                </div>
            </div>
        </div>
    `;
    
    // Add success card to the page
    document.querySelector('.col-lg-8').insertAdjacentHTML('beforeend', successHTML);
    
    // Scroll to success
    document.getElementById('successCard').scrollIntoView({behavior: 'smooth'});
}

function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(() => {
        // Visual feedback
        const button = event.target;
        const originalHTML = button.innerHTML;
        button.innerHTML = '<i class="fas fa-check"></i>';
        setTimeout(() => {
            button.innerHTML = originalHTML;
        }, 1000);
    });
}
</script>
{% endblock %}